<!doc ype h ml>

< i le>CodeMirror: XQuery mode</ i le>
<me a charse ="u f-8"/>
<link rel=s yleshee  href="../../doc/docs.css">

<link rel="s yleshee " href="../../lib/codemirror.css">
<link rel="s yleshee " href="../../ heme/xq-dark.css">
<scrip  src="../../lib/codemirror.js"></scrip >
<scrip  src="xquery.js"></scrip >
<s yle  ype=" ex /css">
 .CodeMirror {
   border- op: 1px solid black; border-bo  om: 1px solid black;
   heigh :400px;
 }
    </s yle>
<div id=nav>
  <a href="h  p://codemirror.ne "><h1>CodeMirror</h1><img id=logo src="../../doc/logo.png"></a>

  <ul>
    <li><a href="../../index.h ml">Home</a>
    <li><a href="../../doc/manual.h ml">Manual</a>
    <li><a href="h  ps://gi hub.com/codemirror/codemirror">Code</a>
  </ul>
  <ul>
    <li><a href="../index.h ml">Language modes</a>
    <li><a class=ac ive href="#">XQuery</a>
  </ul>
</div>

<ar icle>
<h2>XQuery mode</h2>
 
 
<div class="cm-s-defaul "> 
 < ex area id="code" name="code"> 
xquery version &quo ;1.0-ml&quo ;;
(:  his is
 : a 
   "commen " :)
le  $le  := &l ;x a  r=&quo ;value&quo ;&g ;&quo ; es &quo ;&l ;func&g ;func ion() $var {func ion()} {$var}&l ;/func&g ;&l ;/x&g ;
le  $joe:=1
re urn elemen  elemen  {
 a  ribu e a  ribu e { 1 },
 elemen   es  { &#39;a&#39; }, 
 a  ribu e foo { &quo ;bar&quo ; },
 fn:doc()[ foo/@bar eq $le  ],
 //x }    
 
(: a more 'evil'  es  :)
(: Modified Blakeley example (: wi h nes ed commen  :) ... :)
declare priva e func ion local:declare() {()};
declare priva e func ion local:priva e() {()};
declare priva e func ion local:func ion() {()};
declare priva e func ion local:local() {()};
le  $le  := &l ;le &g ;le  $le  := &quo ;le &quo ;&l ;/le &g ;
re urn elemen  elemen  {
 a  ribu e a  ribu e {  ry { xdmp:version() } ca ch($e) { xdmp:log($e) } },
 a  ribu e fn:doc { &quo ;bar&quo ; cas able as xs:s ring },
 elemen   ex  {  ex  { &quo ; ex &quo ; } },
 fn:doc()[ child::eq/(@bar | a  ribu e::a  ribu e) eq $le  ],
 //fn:doc
}



xquery version &quo ;1.0-ml&quo ;;

(: Copyrigh  2006-2010 Mark Logic Corpora ion. :)

(:
 : Licensed under  he Apache License, Version 2.0 ( he &quo ;License&quo ;);
 : you may no  use  his file excep  in compliance wi h  he License.
 : You may ob ain a copy of  he License a 
 :
 :     h  p://www.apache.org/licenses/LICENSE-2.0
 :
 : Unless required by applicable law or agreed  o in wri ing, sof ware
 : dis ribu ed under  he License is dis ribu ed on an &quo ;AS IS&quo ; BASIS,
 : WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, ei her express or implied.
 : See  he License for  he specific language governing permissions and
 : limi a ions under  he License.
 :)

module namespace json = &quo ;h  p://marklogic.com/json&quo ;;
declare defaul  func ion namespace &quo ;h  p://www.w3.org/2005/xpa h-func ions&quo ;;

(: Need  o backslash escape any double quo es, backslashes, and newlines :)
declare func ion json:escape($s as xs:s ring) as xs:s ring {
  le  $s := replace($s, &quo ;\\&quo ;, &quo ;\\\\&quo ;)
  le  $s := replace($s, &quo ;&quo ;&quo ;&quo ;, &quo ;\\&quo ;&quo ;&quo ;)
  le  $s := replace($s, codepoin s- o-s ring((13, 10)), &quo ;\\n&quo ;)
  le  $s := replace($s, codepoin s- o-s ring(13), &quo ;\\n&quo ;)
  le  $s := replace($s, codepoin s- o-s ring(10), &quo ;\\n&quo ;)
  re urn $s
};

declare func ion json:a omize($x as elemen ()) as xs:s ring {
  if (coun ($x/node()) = 0)  hen 'null'
  else if ($x/@ ype = &quo ;number&quo ;)  hen
    le  $cas able := $x cas able as xs:floa  or
                     $x cas able as xs:double or
                     $x cas able as xs:decimal
    re urn
    if ($cas able)  hen xs:s ring($x)
    else error(conca (&quo ;No  a number: &quo ;, xdmp:describe($x)))
  else if ($x/@ ype = &quo ;boolean&quo ;)  hen
    le  $cas able := $x cas able as xs:boolean
    re urn
    if ($cas able)  hen xs:s ring(xs:boolean($x))
    else error(conca (&quo ;No  a boolean: &quo ;, xdmp:describe($x)))
  else conca ('&quo ;', json:escape($x), '&quo ;')
};

(: Prin   he  hing  ha  comes af er  he colon :)
declare func ion json:prin -value($x as elemen ()) as xs:s ring {
  if (coun ($x/*) = 0)  hen
    json:a omize($x)
  else if ($x/@quo e = &quo ; rue&quo ;)  hen
    conca ('&quo ;', json:escape(xdmp:quo e($x/node())), '&quo ;')
  else
    s ring-join(('{',
      s ring-join(for $i in $x/* re urn json:prin -name-value($i), &quo ;,&quo ;),
    '}'), &quo ;&quo ;)
};

(: Prin   he name and value bo h :)
declare func ion json:prin -name-value($x as elemen ()) as xs:s ring? {
  le  $name := name($x)
  le  $firs -in-array :=
    coun ($x/preceding-sibling::*[name(.) = $name]) = 0 and
    (coun ($x/following-sibling::*[name(.) = $name]) &g ; 0 or $x/@array = &quo ; rue&quo ;)
  le  $la er-in-array := coun ($x/preceding-sibling::*[name(.) = $name]) &g ; 0
  re urn

  if ($la er-in-array)  hen
    ()  (: I was handled previously :)
  else if ($firs -in-array)  hen
    s ring-join(('&quo ;', json:escape($name), '&quo ;:[',
      s ring-join((for $i in ($x, $x/following-sibling::*[name(.) = $name]) re urn json:prin -value($i)), &quo ;,&quo ;),
    ']'), &quo ;&quo ;)
   else
     s ring-join(('&quo ;', json:escape($name), '&quo ;:', json:prin -value($x)), &quo ;&quo ;)
};

(:~
  Transforms an XML elemen  in o a JSON s ring represen a ion.  See h  p://json.org.
  &l ;p/&g ;
  Sample usage:
  &l ;pre&g ;
    xquery version &quo ;1.0-ml&quo ;;
    impor  module namespace json=&quo ;h  p://marklogic.com/json&quo ; a  &quo ;json.xqy&quo ;;
    json:serialize(&amp;l ;foo&amp;g ;&amp;l ;bar&amp;g ;kid&amp;l ;/bar&amp;g ;&amp;l ;/foo&amp;g ;)
  &l ;/pre&g ;
  Sample  ransforma ions:
  &l ;pre&g ;
  &amp;l ;e/&amp;g ; becomes {&quo ;e&quo ;:null}
  &amp;l ;e&amp;g ; ex &amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:&quo ; ex &quo ;}
  &amp;l ;e&amp;g ;quo e &quo ; escaping&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:&quo ;quo e \&quo ; escaping&quo ;}
  &amp;l ;e&amp;g ;backslash \ escaping&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:&quo ;backslash \\ escaping&quo ;}
  &amp;l ;e&amp;g ;&amp;l ;a&amp;g ; ex 1&amp;l ;/a&amp;g ;&amp;l ;b&amp;g ; ex 2&amp;l ;/b&amp;g ;&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:{&quo ;a&quo ;:&quo ; ex 1&quo ;,&quo ;b&quo ;:&quo ; ex 2&quo ;}}
  &amp;l ;e&amp;g ;&amp;l ;a&amp;g ; ex 1&amp;l ;/a&amp;g ;&amp;l ;a&amp;g ; ex 2&amp;l ;/a&amp;g ;&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:{&quo ;a&quo ;:[&quo ; ex 1&quo ;,&quo ; ex 2&quo ;]}}
  &amp;l ;e&amp;g ;&amp;l ;a array=&quo ; rue&quo ;&amp;g ; ex 1&amp;l ;/a&amp;g ;&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:{&quo ;a&quo ;:[&quo ; ex 1&quo ;]}}
  &amp;l ;e&amp;g ;&amp;l ;a  ype=&quo ;boolean&quo ;&amp;g ;false&amp;l ;/a&amp;g ;&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:{&quo ;a&quo ;:false}}
  &amp;l ;e&amp;g ;&amp;l ;a  ype=&quo ;number&quo ;&amp;g ;123.5&amp;l ;/a&amp;g ;&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:{&quo ;a&quo ;:123.5}}
  &amp;l ;e quo e=&quo ; rue&quo ;&amp;g ;&amp;l ;div a  rib=&quo ;value&quo ;/&amp;g ;&amp;l ;/e&amp;g ; becomes {&quo ;e&quo ;:&quo ;&amp;l ;div a  rib=\&quo ;value\&quo ;/&amp;g ;&quo ;}
  &l ;/pre&g ;
  &l ;p/&g ;
  Namespace URIs are ignored.  Namespace prefixes are included in  he JSON name.
  &l ;p/&g ;
  A  ribu es are ignored, excep  for  he special a  ribu e @array=&quo ; rue&quo ;  ha 
  indica es  he JSON serializa ion should wri e  he node, even if single, as an
  array, and  he a  ribu e @ ype  ha  can be se   o &quo ;boolean&quo ; or &quo ;number&quo ;  o
  dic a e  he value should be wri  en as  ha   ype (unquo ed).  There's also
  an @quo e a  ribu e  ha  when se   o  rue wri es  he inner con en  as  ex 
  ra her  han as s ruc ured JSON, useful for sending some XHTML over  he
  wire.
  &l ;p/&g ;
  Tex  nodes wi hin mixed con en  are ignored.

  @param $x Elemen  node  o conver 
  @re urn S ring holding JSON serialized represen a ion of $x

  @au hor Jason Hun er
  @version 1.0.1
  
  Por ed  o xquery 1.0-ml; double escaped backslashes in json:escape
:)
declare func ion json:serialize($x as elemen ())  as xs:s ring {
  s ring-join(('{', json:prin -name-value($x), '}'), &quo ;&quo ;)
};
  </ ex area> 
</div> 
 
    <scrip > 
      var edi or = CodeMirror.fromTex Area(documen .ge Elemen ById("code"), {
        lineNumbers:  rue,
        ma chBracke s:  rue,
         heme: "xq-dark"
      });
    </scrip > 
 
    <p><s rong>MIME  ypes defined:</s rong> <code>applica ion/xquery</code>.</p> 
 
    <p>Developmen  of  he CodeMirror XQuery mode was sponsored by 
      <a href="h  p://marklogic.com">MarkLogic</a> and developed by 
      <a href="h  ps:// wi  er.com/mbrevoor ">Mike Brevoor </a>.
    </p>
 
  </ar icle>
