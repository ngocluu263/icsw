{% extends "main.html" %}

{% load i18n extra_tags coffeescript crispy_forms_tags %}

{% block title %}Category tree{% endblock %}

{% block content %}

<div id="icsw.category_tree">

<script type="text/ng-template" id="category.html">
    {% crispy category_form category_form.helper %}
</script>

{% verbatim %}

<script type="text/ng-template" id="cat_head.html">
    <tr>
        <th>Name</th>
        <th>Full name</th>   
        <th>Comment</th>
        <th>refs</th>
        <th>lat</th>
        <th>long</th>
        <th colspan="2">Action</th>
    </tr>
</script>

<script type="text/ng-template" id="cat_row.html">
    <td style="font-family:monospace;"><span ng-bind-html="fn.get_space(obj.depth )"></span>{{ obj.name || '[TLN]' }}</td>
    <td><span ng-show="obj.depth">{{ obj.full_name }}</span></td>
    <td>{{ obj.comment }}</td>
    <td><span ng-show="obj.depth > 1">{{ obj.num_refs || '---' }}</span></td>
    <td><span ng-show="fn.is_location(obj)">{{ obj.latitude }}</span></td>
    <td><span ng-show="fn.is_location(obj)">{{ obj.longitude }}</span></td>
    <td><input type="button" class="btn btn-primary" ng-click="edit($event, obj)" value="modify" ng-show="obj.depth > 1"/></td>
    <td><input type="button" class="btn btn-danger" ng-click="delete(obj)" value="delete" ng-show="obj.depth > 1"/></td>
</script>

<div ng-controller="cat_base">
    <h2>
        Category tree ({{entries.length}} entries),
        <input type="button" value="create new" class="btn btn-success" ng-click="create($event)"/>
        <input type="button" value="prune tree" class="btn btn-warning" ng-click="fn.prune(this)"/>
    </h2>
    <div class="row">
        <div class="col-sm-4">
            <div style="width:auto;">
                <tree treeconfig="cat"></tree>
            </div>
        </div>
        <div class="col-sm-8">
            <table class="table table-condensed table-condensed table-hover" style="width:auto;">
                <thead cathead></thead>
                <tbody>
                    <tr><td colspan="9" paginator entries="entries" pag_settings="pagSettings" per_page="10"></td></tr>
                    <tr catrow ng-repeat="obj in entries | paginator:this" ng-class="fn.get_tr_class(obj)"></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

{% endverbatim %}

<div id="ct_div" class="leftfloat" style="display:none;">
    <input type="button" value="create new entry" id="create_new_dtn"/>
    <input type="button" value="prune tree" id="prune_tree"/>
</div>
<div id="ct_detail" class="leftfloat" style="width:400px; margin-left:auto; margin-right:auto;"></div>
<div id="ct_map" style="width:640px; height:640px;"></div>

<script src="http://maps.google.com/maps/api/js?sensor=false"></script>

<script type="text/javascript">

{% inlinecoffeescript %}

category_tree_module = angular.module("icsw.category_tree", ["ngResource", "ngCookies", "ngSanitize", "ui.bootstrap", "init.csw.filters", "localytics.directives", "restangular"])

angular_module_setup([category_tree_module])

add_tree_directive(category_tree_module)

class category_tree extends tree_config
    constructor: (@scope, args) ->
        super(args)
        @show_selection_buttons = false
        @show_icons = false
        @show_select = false
        @show_descendants = false
        @show_childs = false
    get_name : (t_entry) ->
        cat = t_entry.obj
        if cat.depth > 1
            r_info = "#{cat.full_name} (#{cat.name})"
            if cat.num_refs
                r_info = "#{r_info} (refs=#{cat.num_refs})"
            return r_info
        else if cat.depth
            return cat.full_name
        else
            return "TOP"
    handle_click: (entry, event) =>
        @clear_active()
        entry.active = true
        cat = entry.obj
        if cat.depth > 1
            @scope.edit(event, cat)

angular_add_simple_list_controller(
    category_tree_module,
    "cat_base",
    {
        rest_url            : "{% url 'rest:category_list' %}"
        delete_confirm_str  : (obj) -> return "Really delete category node '#{obj.name}' ?"
        template_cache_list : ["cat_head.html", "cat_row.html"]
        edit_template       : "category.html"
        new_object          : ($scope) ->
            parent = (entry.idx for entry in $scope.entries when entry.depth == 1)[0]
            return {
                "name" : "new"
                "parent" : parent
                "full_name" : "#{parent.full_name}/new"
            }
        object_created: (new_obj, _b, $scope) -> 
            new_obj.name = ""
            $scope.reload()
        post_delete: ($scope, del_obj) ->
            $scope.cat.prune(
                (entry) ->
                    return entry.obj.full_name != del_obj.full_name
            )
            $scope.cat.recalc()
        fn:
            prune: (scope) ->
                if confirm("Really prune the tree ?")
                    $.blockUI()
                    $.ajax
                        url     : "{% url 'base:prune_categories' %}"
                        success : (xml) ->
                            parse_xml_response(xml)
                            scope.reload()
                            $.unblockUI()
            get_tr_class: (obj) ->
                return if obj.depth > 1 then "" else "success"
            is_location: (obj) ->
                # full_name.match leads to infinite digest cycles
                return (obj.depth > 1) and obj.full_name.split("/")[1] == "location"
            get_valid_parents: ($scope) ->
                p_list = (value for value in $scope.entries when value.depth)
                if $scope.edit_obj.idx
                    # remove all nodes below myself
                    r_list = []
                    add_list = [$scope.edit_obj.idx] 
                    while add_list.length
                        r_list = r_list.concat(add_list)
                        add_list = (value.idx for value in p_list when (value.parent in r_list and value.idx not in r_list))
                    p_list = (value for value in p_list when value.idx not in r_list)
                return p_list
            get_space: (depth) ->
                return ("&nbsp;&nbsp;" for idx in [0..depth]).join("")
            modal_closed: (scope) ->
                scope.cat.clear_active()
            rest_data_set: ($scope) ->
                cat_lut = {}
                $scope.cat.clear_root_nodes()
                for entry in $scope.entries
                    t_entry = $scope.cat.new_node({folder:false, obj:entry, expand:entry.depth < 2, selected: entry.immutable})
                    cat_lut[entry.idx] = t_entry
                    if entry.parent
                        #$scope.fqdn_lut[entry.parent].fqdn_childs.push(entry)
                        cat_lut[entry.parent].add_child(t_entry)
                    else
                        $scope.cat.add_root_node(t_entry)
            object_modified: (prev_obj, new_obj, $scope) ->
                if $scope.pre_edit_obj.parent == new_obj.parent
                    $scope.cat.iter(
                        (entry) ->
                            if entry.parent and entry.parent.obj.name
                                entry.obj.full_name = "#{entry.parent.obj.full_name}/#{entry.obj.name}"
                            else
                                entry.obj.full_name = "/#{entry.obj.name}"
                    )
                else
                    $scope.reload()
            delete_node: ($scope, del_obj) ->
                $scope.delete(del_obj)
                $.simplemodal.close()
        init_fn: ($scope, $timeout) ->
            $scope.cat = new category_tree($scope, {})            
    }
)

angular.element(document).ready(() ->
    angular.bootstrap($("div[id='icsw.category_tree']"), ["icsw.category_tree"])
)

class category_treex
    constructor: (@top_div) ->
        @load_ct()
    load_ct: () =>
        $.ajax
            url     : "{% url 'base:category_tree' %}"
            data    :
                with_device_count : 1
            success : (xml) =>
                if parse_xml_response(xml)
                    @DNT = $(xml).find("categories")
                    @my_submitter = new submitter({
                        master_xml       : @DNT,
                        success_callback : @change_cb
                    })
                    @bind_buttons()
                    @build_tree()
    bind_buttons: () =>
        $("input#create_new_dtn").off("click").on("click", @create_new)
        $("input#prune_tree").off("click").on("click", @prune_tree)
    prune_tree: (event) =>
        if confirm("Really prune the tree ?")
            window.location = "{% url 'base:prune_categories' %}"
    create_new: (event) =>
        $.ajax
            # {#url     : "{% url 'base:create_category' %}" #}
            type    : "GET"
            success : (xml) =>
                if parse_xml_response(xml)
                    detail_div = $("div#ct_detail")
                    detail_div.children().remove()
                    detail_div.append($(xml).find("value[name='form']").text())
                    #detail_div.uniform()
                    $("div#ct_detail form").bind("submit", @submit_form)
    submit_form: (event) =>
        $.ajax
            #{# url     : "{% url 'base:create_category' %}"#}
            data    : create_dict($("div#ct_detail"), "cat__new", true)
            success : (xml) =>
                if parse_xml_response(xml)
                    # add new nodes (also the ones created as intermediate nodes)
                    $(xml).find("value[name='new_nodes'] category").each (idx, new_node) =>
                        new_node = $(new_node)
                        if not @DNT.find("category[pk='" + new_node.attr("pk") + "']").length
                            @DNT.find("category[parent='0']").after(new_node)
                            @build_node(@top_div.dynatree("getTree").getNodeByKey(new_node.attr("parent")), new_node)
        return false
    build_tree: () =>
        @cur_key = 0
        @top_div.dynatree
            autoFocus  : false
            debuglevel : {% if DEBUG %}0{% else %}0{% endif %}
            onExpand : (flag, dtnode) =>
            onSelect : (flag, dtnode) =>
            onFocus  : (dtnode) =>
                if dtnode.data.key != @cur_key
                    @cur_key = dtnode.data.key
                    @show_details(dtnode.data.key)
                return false
            dnd : {
                onDragStart : (dtnode) =>
                    #console.log dtnode.data.title
                    return true
                onDragEnter : (dest_node, src_node) =>
                    if parseInt(@DNT.find("category[pk='#{src_node.data.key}']").attr("parent")) == 0
                        return false
                    else
                        return true
                onDrop: (dst_node, src_node, hit_mode, ui, draggable) =>
                    # node needs at least depth >= 2
                    src_db_node = @DNT.find("category[pk='#{src_node.data.key}']")
                    if parseInt(src_db_node.attr("immutable")) == 1
                        return false
                    src_root_node = src_db_node
                    while parseInt(src_root_node.attr("depth")) > 1
                        src_root_node = @DNT.find("category[pk='" + src_root_node.attr("parent") + "']")
                    dst_root_node = @DNT.find("category[pk='#{dst_node.data.key}']")
                    while parseInt(dst_root_node.attr("depth")) > 1
                        dst_root_node = @DNT.find("category[pk='" + dst_root_node.attr("parent") + "']")
                    # not allowed to move between main branches
                    if parseInt(src_root_node.attr("immutable")) and parseInt(dst_root_node.attr("immutable")) and src_root_node.attr("name") != dst_root_node.attr("name")
                        return false
                    # check if src_node is not a parent of dst_node
                    move = true
                    c_node = dst_node
                    while true
                        if c_node.data.key == src_node.data.key
                            move = false
                        c_node = c_node.getParent()
                        if not c_node
                            break
                    if move
                        $.ajax
                            # {# url     : "{% url 'base:move_category' %}"#}
                            data    : {
                                "src_id" : src_node.data.key
                                "dst_id" : dst_node.data.key
                                "mode"   : hit_mode
                            }
                            success : (xml) =>
                                if parse_xml_response(xml)
                                    src_db_node = @DNT.find("category[pk='#{src_node.data.key}']")
                                    if hit_mode == "over" or hit_mode == "child"
                                        src_db_node.attr("parent", dst_node.data.key)
                                    else
                                        src_db_node.attr("parent", @DNT.find("category[pk='#{dst_node.data.key}']").attr("parent"))
                                    @rename_tree(src_node)
                                    # move src_node to dst_node, according to hit_mode
                                    src_node.move(dst_node, hit_mode)
            }
            #onCustomRender : (dtnode) =>
            #    db_node = @DNT.find("category[pk='#{dtnode.data.key}']")
            #    if db_node.attr("intermediate") == "1"
            #        render_el = $("<span>").text(dtnode.data.title)
            #    else
            #        render_el = $("<span>").text(dtnode.data.title + "...")
            #    return render_el.html()
        @root_node = @top_div.dynatree("getRoot")
        @build_node(@root_node, @DNT.find("category[parent='0']"))
    build_node: (dt_node, db_node) =>
        if parseInt(db_node.attr("parent")) == 0
            title_str = "TOP"
            expand_flag = true
        else
            info_str = db_node.attr("full_name")
            if parseInt(db_node.attr("device_count"))
                info_str = info_str + ", dc=" + db_node.attr("device_count")
            title_str = db_node.attr("name") + " (" + info_str + ")"
            expand_flag = false
        new_node = dt_node.addChild(
            title    : title_str
            expand   : expand_flag
            key      : db_node.attr("pk")
            select   : if parseInt(db_node.attr("immutable")) then true else false
            addClass : if db_node.attr("intermediate") == "1" then "intermediate" else "ip_ok"
        )
        @DNT.find("category[parent='" + db_node.attr("pk") + "']").each (idx, sub_db_node) =>
            @build_node(new_node, $(sub_db_node))
    _get_latlong: (db_node) =>
        return new google.maps.LatLng(parseFloat(db_node.attr("latitude")), parseFloat(db_node.attr("longitude")))
    show_details: (key) =>
        db_node = @DNT.find("category[pk='#{key}']")
        if parseInt(db_node.attr("immutable")) == 0
            $.ajax
                # {# url     : "{% url 'base:category_detail' %}" #}
                data     : {
                    "key" : key
                }
                success : (xml) =>
                    if parse_xml_response(xml)
                        @active_node = key
                        $("div#ct_map").hide().children().remove()
                        detail_div = $("div#ct_detail")
                        detail_div.children().remove()
                        detail_div.append($(xml).find("value[name='form']").text())
                        detail_div.find("input").on("change", @my_submitter.submit)
                        cur_dtn = @DNT.find("category[pk='#{key}']")
                        detail_div.find("input#button-id-delete").off("change").on("click", @delete_node)
                        if db_node.attr("full_name").match("/location/")
                            @show_map_info(db_node)
                        $.ajax
                            # {# url     : "{% url 'base:get_cat_references' %}" #}
                            data    :
                                "key" : key 
                            success : (xml) =>
                                if parse_xml_response(xml)
                                    obj_div = $("<div>").attr("id", "ref_objects")
                                    obj_div.dynatree()
                                    $("div#ct_detail").append(obj_div)
                                    root_node = obj_div.dynatree("getRoot")
                                    ref_list = $(xml).find("references")
                                    ref_list.find("> *").each (idx, sub_list) =>
                                        sub_list = $(sub_list)
                                        sub_node = root_node.addChild(
                                            title    : sub_list.prop("tagName") + " (" + sub_list.attr("count") + ")"
                                            isFolder : true
                                        )
                                        sub_list.find("*").each (sub_idx, entry) =>
                                            sub_node.addChild(
                                                title : $(entry).text()
                                            )
        else
            detail_div = $("div#ct_detail")
            detail_div.children().remove()
            $("div#ct_map").hide().children().remove()
    show_map_info: (db_node) =>
        $("div#ct_map").show()
        ll_fields = $("input[name='latitude'], input[name='longitude']")
        ll_fields.on("change", ->
            cur_ll = new google.maps.LatLng(parseFloat($("input[name='latitude']").val()), parseFloat($("input[name='longitude']").val()))
            my_marker.setPosition(cur_ll)
            if not my_map.getBounds().contains(my_marker.getPosition())
                my_map.setCenter(my_marker.getPosition())
        )
        loc_latlng = @_get_latlong(db_node)
        my_map = new google.maps.Map($("div#ct_map")[0], {
            zoom              : 10,
            center            : loc_latlng
            mapTypeId         : google.maps.MapTypeId.ROADMAP
            streetViewControl : false
        })
        google.maps.event.addListener(my_map, "zoom_changed", ->
        )
        my_marker = new google.maps.Marker(
            position : loc_latlng,
            map      : my_map,
            title    : db_node.attr("full_name")
        )
        # add other markers
        google.maps.event.addListener(my_map, "click", (event) ->
            my_marker.setPosition(event.latLng)
            $("input[name='longitude']").val(event.latLng.lng())
            $("input[name='latitude']").val(event.latLng.lat()).trigger("change")
        )
        # add other markers
        @DNT.find("category[full_name^='/location/']").each (idx, other_loc) =>
            other_loc = $(other_loc)
            if other_loc.attr("pk") != db_node.attr("pk")
                new google.maps.Marker(
                    position : @_get_latlong(other_loc)
                    map      : my_map,
                    icon     : 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    title    : other_loc.attr("full_name")
                )
    delete_node: (event) =>
        $.ajax
            # {# url     : "{% url 'base:delete_category' %}" #}
            data    : {
                "key" : @active_node
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    $("div#ct_detail").children().remove()
                    @top_div.dynatree("getTree").getNodeByKey(@active_node).remove()
    rename_tree: (cur_node) =>
        cur_db_node    = @DNT.find("category[pk='#{cur_node.data.key}']")
        parent_db_node = @DNT.find("category[pk='" + cur_db_node.attr("parent") + "']")
        #console.log parent_db_node.attr("pk"), cur_db_node.attr("name"), parent_db_node.attr("full_name")
        cur_db_node.attr("full_name", parent_db_node.attr("full_name") + "/" + cur_db_node.attr("name"))
        cur_node.data.title = cur_db_node.attr("name") + " (" + cur_db_node.attr("full_name") + ")"
        cur_node.render()
        if cur_node.hasChildren()
            for sub_node in cur_node.getChildren()
                @rename_tree(sub_node)
    change_cb: (cur_el) =>
        c_type = cur_el.attr("id").split("__")[2]
        node_key = cur_el.attr("id").split("__")[1]
        dt_node = @top_div.dynatree("getTree").getNodeByKey(node_key)
        if c_type == "name"
            @rename_tree(dt_node, cur_el.val())
        else if c_type == "intermediate"
            if cur_el.is(":checked")
                dt_node.data.addClass = "intermediate"
            else
                dt_node.data.addClass = "ip_ok"
            dt_node.render()
            #console.log @DNT.find("category[pk='#{dt_node.data.key}']").attr("intermediate")
        if c_type == "latitude"
            # send longitude after latitude
            $("input[name='longitude']").trigger("change")

$(document).ready(
    #my_ct = new category_treex($("div#ct_div"))
)

{% endinlinecoffeescript %}

</script>

{% endblock %}
