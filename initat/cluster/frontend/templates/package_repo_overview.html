{% extends "main.html" %}

{% load i18n compress coffeescript crispy_forms_tags %}

{% block title %}{% trans "Package Install" %}{% endblock %}

{% block content %}

<div ng-app="icsw.package">

<script type="text/ng-template" id="package_search.html">
    {% crispy package_search_form package_search_form.helper %}
</script>

<script type="text/ng-template" id="package_action.html">
    {% crispy package_action_form package_action_form.helper %}
</script>

{% verbatim %}

<script type="text/ng-template" id="package_repo_head.html">
    <tr>
        <th>Name</th>
        <th>Alias</th>
        <th>Enabled</th>
        <th>AutoRefresh</th>
        <th>GPGcheck</th>
        <th>publish</th>
        <th>URL</th>   
        <th colspan="2" class="text-center">action</th>   
    </tr>
</script>

<script type="text/ng-template" id="pdc_state.html">
    <td ng-class="get_td_class()" class="text-center">
        <span ng-show="show_pdc()">
            <span ng-show="pdc.force_flag">F</span>
            <span ng-show="pdc.nodeps_flag">N</span>
            {{ pdc.target_state }}
        </span>
        <span ng-show="!show_pdc()">
        </span>
        <input type="checkbox" ng-model="pdc.selected" ng-change="change_sel()"></input>
    </td>
</script>

<script type="text/ng-template" id="package_repo_row.html">
    <td>{{ obj.name }}</td>
    <td>{{ obj.alias }}</td>
    <td>{{ obj.enabled | yesno1 }}</td>
    <td>{{ obj.autorefresh | yesno1 }}</td>
    <td>{{ obj.gpg_check | yesno1 }}</td>
    <td>{{ obj.publish_to_nodes | yesno1 }}</td>
    <td>{{ obj.url }}</td>
    <td><input type="button" class="btn btn-primary" ng-click="fn.toggle(obj)" value="toggle"/></td>
    <td><input type="button" class="btn btn-danger" ng-click="delete(obj)" value="delete"/></td>
</script>

<script type="text/ng-template" id="package_search_head.html">
    <tr>
        <th>Search string</th>
        <th>User</th>
        <th>repeat</th>
        <th>State</th>
        <th>results</th>
        <th>search</th>
        <th>last search</th>   
        <th colspan="4" class="text-center">action</th>   
    </tr>
</script>

<script type="text/ng-template" id="package_search_row.html">
    <td>{{ obj.search_string }}</td>
    <td>{{ obj.user | array_lookup:this.rest_data.user | show_user }}</td>
    <td>{{ obj.num_searches }}</td>
    <td>{{ obj.current_state }}</td>
    <td>{{ obj.results }}</td>
    <td>{{ obj.last_search_string }}</td>
    <td class="text-right">{{ obj.last_search | datetime1 }}</td>
    <td><input type="button" class="btn btn-primary" ng-show="obj.results > 0" ng-click="fn.show(this, obj)" value="show"/></td>
    <td><input type="button" class="btn btn-primary" ng-show="obj.current_state == 'done'" ng-click="fn.retry(this, obj)" value="retry"/></td>
    <td><input type="button" class="btn btn-primary" ng-show="obj.current_state == 'done'" ng-click="edit($event, obj)" value="modify"/></td>
    <td><input type="button" class="btn btn-danger" ng-click="delete(obj)" value="delete"/></td>
</script>

<script type="text/ng-template" id="package_search_result_head.html">
    <tr>
        <th>name</th>
        <th>version</th>
        <th>kind</th>
        <th>repo</th>
        <th>arch</th>
        <th colspan="3" class="text-center">action</th>   
    </tr>
</script>

<script type="text/ng-template" id="package_search_result_row.html">
    <td>{{ obj.name }}</td>
    <td>{{ obj.version }}</td>
    <td>{{ obj.kind }}</td>
    <td>{{ obj.package_repo | array_lookup:this.rest_data.package_repo:"name" }}</td>
    <td>{{ obj.arch }}</td>
    <td><input type="button" ng-show="obj.copied == 0" class="btn btn-primary" ng-click="fn.take(this, obj, true)" value="take exact"/></td>
    <td><input type="button" ng-show="obj.copied == 0" class="btn btn-primary" ng-click="fn.take(this, obj, false)" value="take latest"/></td>
    <td><input type="button" class="btn btn-danger" ng-click="delete(obj)" value="delete"/></td>
</script>

<script type="text/ng-template" id="package_head.html">
    <tr>
        <th>name</th>
        <th>version</th>
        <th>Repository</th>
        <th>kind</th>
        <th>arch</th>
        <th colspan="3" class="text-center">action</th>   
    </tr>
</script>

<script type="text/ng-template" id="package_row.html">
    <td>{{ obj.name }}</td>
    <td ng-show="obj.always_latest == false">{{ obj.version }}</td>
    <td ng-show="obj.always_latest == true">&lt;latest&gt;</td>
    <td>{{ obj.package_repo | array_lookup:this.rest_data.package_repo:"name" }}</td>
    <td>{{ obj.kind }}</td>
    <td>{{ obj.arch }}</td>
    <td><input type="button" class="btn btn-primary" ng-click="attach(obj)" value="attach" title="attach to selected devices"/></td>
    <td><input type="button" class="btn btn-warning" ng-click="remove(obj)" value="remove" title="remove from selected devices"/></td>
    <td><input type="button" class="btn btn-danger" ng-click="delete(obj)" value="delete"/></td>
</script>

<tabset>
    <tab heading="Package repositories">
        <div ng-controller="package_repo_base">
            <h3>Repositories ({{entries.length}} entries), <input type="button" value="Rescan" ng-click="fn.rescan(this)"/>, <input type="button" value="Sync to clients" ng-click="fn.sync(this)"/></h3>
            <table class="table table-condensed table-condensed table-hover" style="width:auto;">
                <thead packagerepohead></thead>
                <tbody>
                    <tr><td colspan="9" paginator entries="entries" pag_settings="pagSettings" per_page="10"></td></tr>
                    <tr packagereporow ng-repeat="obj in entries | orderBy:'-name':true | paginator:this"></tr>
                </tbody>
            </table>
        </div>
    </tab>
    <tab heading="Package search">
        <div ng-controller="package_search_base">
            <h3>Searches ({{entries.length}} entries), <input type="button" value="create new" ng-click="create($event)"/></h3>
            <table class="table table-condensed table-condensed table-hover" style="width:auto;">
                <thead packagesearchhead></thead>
                <tbody>
                    <tr><td colspan="9" paginator entries="entries" pag_settings="pagSettings" per_page="10"></td></tr>
                    <tr packagesearchrow ng-repeat="obj in entries | orderBy:'-search_string':true | paginator:this"></tr>
                </tbody>
            </table>
        </div>
        <div ng-controller="package_search_result_base">
            <div ng-show="entries.length > 0">
                <h3>Search results for '{{ shared_data.result_obj.last_search_string }}' ({{ entries | paginator_filter:this | array_length }} entries)</h3>
                <table class="table table-condensed table-condensed table-hover" style="width:auto;">
                    <thead packagesearchresulthead></thead>
                    <tbody>
                        <tr><td colspan="9" paginator entries="entries" pag_settings="pagSettings" per_page="15" paginator_filter="1"></td></tr>
                        <tr packagesearchresultrow ng-repeat="obj in entries | orderBy:'-name':true | paginator:this"></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </tab>
    <tab heading="Install">
        <div ng-controller="package_base">
            <div ng-controller="install">
                <h3>
                    <form class="form-inline" role="form">
                        Grid ({{ entries.length }} packages, {{ devices.length }} devices), {{ selected_pdcs_length() }} selected, filter:
                        <div class="form-group">
                            <input ng-model="package_filter" class="form-control input-sm""></input>
                        </div>,
                        <input ng-show="selected_pdcs_length()" type="button" class="btn btn-success btm-sm" value="action" ng-click="action($event)"></input>
                    </form>
                </h3>
                <table class="table table-condensed" style="width:auto;">
                    <thead>
                       <tr>
                           <th colspan="2">&nbsp;</th>
                           <th ng-repeat="dev in devices">
                              {{ dev.name }}
                           </td>
                       </th>
                       <tr>
                           <th>Package</th>
                           <th>action</th>
                           <th ng-repeat="dev in devices" class="text-center">
                               <input type="button" class="btn btn-primary btn-xs" ng-click="change_device_sel(dev, 1)" value="S"></input>
                               <input type="button" class="btn btn-success btn-xs" ng-click="change_device_sel(dev, 0)" value="T"></input>
                               <input type="button" class="btn btn-warning btn-xs" ng-click="change_device_sel(dev, -1)" value="C"></input>
                           </td>
                       </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="pack in entries | filter:package_filter">
                            <td>
                                {{ pack.name }}
                                <span ng-show="pack.always_latest == false">{{ pack.version }}</span>
                                <span ng-show="pack.always_latest == true">&lt;latest&gt;</span>
                            </td>
                            <td>
                                <input type="button" class="btn btn-primary btn-xs" ng-click="change_package_sel(pack, 1)" value="S"></input>
                                <input type="button" class="btn btn-success btn-xs" ng-click="change_package_sel(pack, 0)" value="T"></input>
                                <input type="button" class="btn btn-warning btn-xs" ng-click="change_package_sel(pack, -1)" value="C"></input>
                            </td>
                            <td ng-repeat="device in devices" istate pdc="state_dict[device.idx][pack.idx]" pdcs="$parent.selected_pdcs"></td>
                        </tr>
                    </tbody>
                </table>
                <h3>Packages ({{ entries | paginator_filter:this | array_length }} entries)</h3>
                <table class="table table-condensed table-condensed table-hover" style="width:auto;">
                    <thead packagehead></thead>
                    <tbody>
                        <tr><td colspan="9" paginator entries="entries" pag_settings="pagSettings" per_page="10" paginator_filter="1"></td></tr>
                        <tr packagerow ng-repeat="obj in entries | orderBy:'-search_string':true | paginator:this"></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </tab>
</tabset>

{% endverbatim %}

{% endblock %}
