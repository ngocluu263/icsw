{% extends "main.html" %}

{% load i18n extra_tags coffeescript crispy_forms_tags %}

{% block title %}Domain name tree{% endblock %}

{% block content %}

<div id="icsw.domain_name_tree">

<script type="text/ng-template" id="domain_name_tree.html">
    {% crispy domain_name_tree_form domain_name_tree_form.helper %}
</script>

{% verbatim %}

<script type="text/ng-template" id="dtn_head.html">
    <tr>
        <th>Name</th>   
        <th>Nodename</th>
        <th>depth</th>
        <th>postfix</th>
        <th>comment</th>
        <th>SN</th>
        <th>IP</th>
        <th>NS</th>
        <th>Action</th>
    </tr>
</script>

<script type="text/ng-template" id="dtn_row.html">
    <td>{{ obj.name || '[TLN]' }}</td>
    <td><span ng-show="obj.depth">*.{{ obj.full_name }}</span></td>
    <td>{{ obj.depth }}</td>
    <td>{{ obj.postfix }}</td>
    <td>{{ obj.comment }}</td>
    <td>{{ obj.create_short_names | yesno1 }}</td>
    <td>{{ obj.always_create_ip | yesno1 }}</td>
    <td>{{ obj.write_nameserver_config | yesno1 }}</td>
    <td><input type="button" class="btn btn-primary" ng-click="edit($event, obj)" value="modify" ng-show="obj.depth"/></td>
</script>

<div ng-controller="dnt_base">
    <h2>Domain tree ({{entries.length}} entries), <input type="button" value="create new" class="btn btn-success" ng-click="create($event)"/></h2>
    <div class="row">
        <div class="col-sm-6">
            <table class="table table-condensed table-condensed table-hover" style="width:auto;">
                <thead dtnhead></thead>
                <tbody>
                    <tr><td colspan="9" paginator entries="entries" pag_settings="pagSettings" per_page="10"></td></tr>
                    <tr dtnrow ng-repeat="obj in entries | paginator:this"></tr>
                </tbody>
            </table>
        </div>
        <div class="col-sm-6">
            <div style="width:auto;">
                <tree treeconfig="dnt"></tree>
            </div>
        </div>
    </div>
</div>
</div>

{% endverbatim %}

<script type="text/javascript">

{% inlinecoffeescript %}

domain_name_tree_module = angular.module("icsw.domain_name_tree", ["ngResource", "ngCookies", "ngSanitize", "ui.bootstrap", "init.csw.filters", "localytics.directives", "restangular"])

angular_module_setup([domain_name_tree_module])

add_tree_directive(domain_name_tree_module)

class domain_name_tree extends tree_config
    constructor: (@scope, args) ->
        super(args)
        @show_selection_buttons = false
        @show_icons = false
        @show_select = false
        @show_descendants = true
    handle_click: (entry, event) =>
      if entry._node_type == "d"
          dev = @scope.dev_lut[entry.obj]
          if dev.device_type_identifier != "MD"
              show_device_info(event, "dev__#{dev.idx}")
    get_name : (t_entry) ->
        dtn = t_entry.obj
        if dtn.parent
            return "#{dtn.name} (*.#{dtn.full_name})"
        else
            return "TOP"
    handle_click: (entry, event) =>
        @clear_active()
        entry.active = true
        dtn = entry.obj
        if dtn.parent
            @scope.edit(event, dtn)

angular_add_simple_list_controller(
    domain_name_tree_module,
    "dnt_base",
    {
        rest_url            : "{% url 'rest:domain_tree_node_list' %}"
        delete_confirm_str  : (obj) -> return "Really delete domain tree node '#{obj.name}' ?"
        template_cache_list : ["dtn_head.html", "dtn_row.html"]
        edit_template       : "domain_name_tree.html"
        new_object          : ($scope) ->
            return {
                "name" : "new"
                "parent" : (entry.idx for entry in $scope.entries when entry.depth == 0)[0]
                "create_short_names" : true
            }
        object_created: (new_obj, _b, $scope) -> 
            new_obj.name = ""
            $scope.reload()
        post_delete: ($scope, del_obj) ->
            $scope.dnt.prune(
                (entry) ->
                    return entry.obj.full_name != del_obj.full_name
            )
            $scope.dnt.recalc()
        fn:
            modal_closed: (scope) ->
                scope.dnt.clear_active()
            rest_data_set: ($scope) ->
                fqdn_lut = {}
                $scope.dnt.clear_root_nodes()
                for entry in $scope.entries
                    t_entry = $scope.dnt.new_node({folder:false, obj:entry, expand:entry.depth == 0})
                    fqdn_lut[entry.idx] = t_entry
                    if entry.parent
                        #$scope.fqdn_lut[entry.parent].fqdn_childs.push(entry)
                        fqdn_lut[entry.parent].add_child(t_entry)
                    else
                        $scope.dnt.add_root_node(t_entry)
            object_modified: (prev_obj, new_obj, $scope) ->
                $scope.reload()
            delete_node: ($scope, del_obj) ->
                $scope.delete(del_obj)
                $.simplemodal.close()
        init_fn: ($scope, $timeout) ->
            $scope.dnt = new domain_name_tree($scope, {})
            
    }
)

angular.element(document).ready(() ->
    angular.bootstrap($("div[id='icsw.domain_name_tree']"), ["icsw.domain_name_tree"])
)

{% endinlinecoffeescript %}

</script>

{% endblock %}
