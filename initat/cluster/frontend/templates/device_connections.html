{% extends "main.html" %}

{% load i18n coffeescript %}

{% block title %}{% trans "Device connections" %}{% endblock %}

{% block content %}

<div id="icsw.device.connection">
<div ng-controller="connection_ctrl">
{% verbatim %}

    <h2>Device connections, {{ cd_devs.length }} controlling devices selected</h2>
    <table ng-show="cd_devs.length" class="table table-condensed table-hover" style="width:auto;">
        <tbody>
            <tr ng-repeat-start="dev in cd_devs" class="success">
                <th colspan="2">{{ dev.full_name }} ({{ dev.comment }})</th>
            </tr>
            <tr>
                <td>
                    <div class="input-group-btn">
                        <div class="btn-group">
                            <button class="btn btn-success dropdown-toggle btn-sm" data-toggle="dropdown">
                                is master for <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li ng-repeat="pk in get_valid_devs(dev)">
                                    <a href="#" ng-click="create_master(dev, pk)">{{ get_device_info(pk) }}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="input-group-btn">
                        <div class="btn-group">
                            <button class="btn btn-success dropdown-toggle btn-sm" data-toggle="dropdown">
                                is slave of <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                <li ng-repeat="pk in get_valid_devs(dev)">
                                    <a href="#" ng-click="create_slave(dev, pk)">{{ get_device_info(pk) }}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </td>
            </tr>
            <tr ng-repeat-end>
                <td>
                    <ul class="list-group">
                        <li ng-repeat="el in dev.master_list" class="list-group-item">
                            <button class="btn btn-xs btn-danger" ng-click="delete_cd(el, dev, $event)">delete</button>&nbsp;
                            <button class="btn btn-xs btn-warning" ng-click="modify_cd(el, $event)">modify</button>
                            {{ el.child | follow_fk:this:'devices':'full_name' }}
                            ({{ el.connection_info }}; {{ el.parameter_i1 }} / 
                            {{ el.parameter_i2 }} / 
                            {{ el.parameter_i3 }} / 
                            {{ el.parameter_i4 }})
                        </li>
                    </ul>
                </td>
                <td>
                    <ul class="list-group">
                        <li ng-repeat="el in dev.slave_list" class="list-group-item">
                            <button class="btn btn-xs btn-danger" ng-click="delete_cd(el, dev, $event)">delete</button>&nbsp;
                            <button class="btn btn-xs btn-warning" ng-click="modify_cd(el, $event)">modify</button>
                            {{ el.parent | follow_fk:this:'devices':'full_name' }}
                            ({{ el.connection_info }}; {{ el.parameter_i1 }} / 
                            {{ el.parameter_i2 }} / 
                            {{ el.parameter_i3 }} / 
                            {{ el.parameter_i4 }}) 
                        </li>
                    </ul>
                </td>
            </tr>
        </tbody>
    </table>
    <h3>Automatic creation</h3>
    <form class="form-inline">
        Set
        <div class="form-group">
            <input type="text" class="form-control" ng-model="ac_host"></input> 
        </div>
        (Host) as <input type="button" class="btn btn-sn btn-primary" ng-value="ac_type" ng-click="change_ac_type()"></input>
        for
        <div class="form-group">
            <input type="text" class="form-control" ng-model="ac_cd"></input> 
        </div>
        (Controlling device)
        <input type="button" ng-show="ac_host && ac_cd" class="btn btn-success" value="create" ng-click="handle_ac()"></input>
    </form>
    Example: 'node##' as Slave for 'ipmi##' (2 digits).
{% endverbatim %}
</div>
</div>

<script type="text/javascript">

{% inlinecoffeescript %}

device_connection_module = angular.module("icsw.device.connection", ["ngResource", "ngCookies", "ngSanitize", "ui.bootstrap", "init.csw.filters", "localytics.directives", "restangular"])

angular_module_setup([device_connection_module])

device_connection_module.controller("connection_ctrl", ["$scope", "$compile", "$filter", "$templateCache", "Restangular", "paginatorSettings", "restDataSource", "sharedDataSource", "$q", "$modal",
    ($scope, $compile, $filter, $templateCache, Restangular, paginatorSettings, restDataSource, sharedDataSource, $q, $modal) ->
        $scope.devsel_list = []
        # ac settings
        $scope.ac_type = "master"
        $scope.change_ac_type = () ->
            $scope.ac_type = if $scope.ac_type == "master" then "slave" else "master"
        $scope.handle_ac = () ->
            $.blockUI()
            $.ajax
                url   : "{% url 'device:manual_connection' %}"
                data  : {
                    "source" : $scope.ac_host
                    "target" : $scope.ac_cd
                    "mode"   : $scope.ac_type
                }
                success : (xml) =>
                    $.unblockUI()
                    # show info
                    parse_xml_response(xml, 30)
                    # reload (even on error)
                    $scope.reload()
        # mixins
        $scope.cd_edit = new angular_edit_mixin($scope, $templateCache, $compile, $modal, Restangular, $q)
        $scope.cd_edit.create_template = "cd_connection_form.html"
        $scope.cd_edit.edit_template = "cd_connection_form.html"
        $scope.cd_edit.create_rest_url = Restangular.all("{% url 'rest:cd_connection_list'%}".slice(1))
        $scope.cd_edit.modify_rest_url = "{% url 'rest:cd_connection_detail' 1 %}".slice(1).slice(0, -2)
        $scope.cd_edit.new_object_at_tail = true
        $scope.cd_edit.use_promise = true

        $scope.new_devsel = (_dev_sel, _devg_sel) ->
            $scope.devsel_list = _dev_sel
            $scope.reload()
        $scope.reload = () ->
            restDataSource.reset()
            wait_list = restDataSource.add_sources([
                ["{% url 'rest:device_tree_list' %}", {"pks" : angular.toJson($scope.devsel_list), "cd_connections" : true, "olp" : "backbone.device.change_connection"}],
                ["{% url 'rest:cd_connection_list' %}", {}]
                ["{% url 'rest:fetch_forms' %}", {"forms" : angular.toJson(["cd_connection_form"])}]
            ])
            $q.all(wait_list).then((data) ->
                _devs = data[0]
                $scope.devices = build_lut(_devs)
                $scope.cd_devs = []
                for entry in _devs
                    if entry.device_type_identifier == "CD" and entry.idx in $scope.devsel_list
                        entry.master_list = []
                        entry.slave_list = []
                        $scope.cd_devs.push(entry)
                $scope.cd_lut = build_lut($scope.cd_devs)
                for _cd in data[1]
                    if _cd.parent of $scope.cd_lut
                        $scope.cd_lut[_cd.parent].master_list.push(_cd)
                    if _cd.child of $scope.cd_lut
                        $scope.cd_lut[_cd.child].slave_list.push(_cd)
                for cur_form in data[2] 
                    $templateCache.put(cur_form.name, cur_form.form)
            )
        $scope.modify_cd = (cd, event) ->
            $scope.cd_edit.edit(cd, event).then(
                (mod_cd) ->
                    if mod_cd != false
                        # nothing
                        true
            )
        $scope.delete_cd = (cd, dev, event) ->
            $scope.cd_edit.delete_list = undefined
            $scope.cd_edit.delete_obj(cd).then(
                (do_it) ->
                    if do_it
                        dev.master_list = (entry for entry in dev.master_list when entry.idx != cd.idx)
                        dev.slave_list = (entry for entry in dev.slave_list when entry.idx != cd.idx)
            )
        $scope.get_valid_devs = (dev) ->
            # return all valid devices for given cd
            _ms_pks = (entry.child for entry in dev.master_list).concat((entry.parent for entry in dev.slave_list))
            valid_pks = (pk for pk in $scope.devsel_list when pk != dev.idx and pk not in _ms_pks)
            return valid_pks
        $scope.get_device_info = (pk) ->
            return $scope.devices[pk].full_name
        $scope.create_master = (dev, pk) ->
            new_obj = {
                "parent" : dev.idx
                "child"  : pk
                "connection_info" : "from webfrontend"
                "created_by" : CURRENT_USER.pk
            }
            $scope.cd_edit.create_rest_url.post(new_obj).then((data) ->
                dev.master_list.push(data)
            )
        $scope.create_slave = (dev, pk) ->
            new_obj = {
                "parent" : pk
                "child"  : dev.idx
                "connection_info" : "from webfrontend"
                "created_by" : CURRENT_USER.pk
            }
            $scope.cd_edit.create_rest_url.post(new_obj).then((data) ->
                dev.slave_list.push(data)
            )
        install_devsel_link($scope.new_devsel, true, true, false)
    ]
).run(($templateCache) ->
    $templateCache.put("simple_confirm.html", simple_modal_template)
)
angular.element(document).ready(() ->
    angular.bootstrap($("div[id='icsw.device.connection']"), ["icsw.device.connection"])
)

{% endinlinecoffeescript %}

</script>

{% endblock %}
