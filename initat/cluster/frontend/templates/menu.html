{% load i18n coffeescript staticfiles %}

<nav class="navbar navbar-default navbar-static-top" role="navigation" id="icsw.menu_app" ng-controller="menu_base">
    <div class="navbar-header">
        <ul class="nav navbar-nav">
            <li>
                <a href="{% url 'main:index' %}"><span class="glyphicon glyphicon-home"></span></a>
            </li>
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Base" %} <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'device:tree' %}">{% trans "Device tree" %}</a></li>
                    <li><a href="{% url 'network:domain_name_tree' %}">{% trans "Domain name tree" %}</a></li>
                    <li><a href="{% url 'base:category_tree' %}">{% trans "Category tree" %}</a></li>
                    <li class="divider"></li>
                    <li><a href="{% url 'network:show_networks' %}">{% trans "Networks" %}</a></li>
                    <li><a href="{% url 'config:show_configs' %}">{% trans "Configurations" %}</a></li>
                    <li class="divider"></li>
                    <li><a href="{% url 'network:device_network' %}">{% trans "Device network" %}</a></li>
                    <li><a href="{% url 'device:connections' %}">{% trans "Device connections" %}</a></li>
                    <li><a href="{% url 'device:variables' %}">{% trans "Device variables" %}</a></li>
                    <li><a href="{% url 'device:show_configs' %}">{% trans "Device configurations" %}</a></li>
                </ul>
            </li>
            {% if settings.CLUSTER_LICENSE.boot %}
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Cluster" %} <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'boot:show_boot' %}">{% trans "Nodeboot" %}</a></li>
                    {% if settings.CLUSTER_LICENSE.package %}
                      <li><a href="{% url 'pack:repo_overview' %}">{% trans "Package install" %}</a></li>
                    {% endif %}
                    <li class="divider"></li>
                    <li><a href="{% url 'setup:image_overview' %}">{% trans "Image overview" %}</a></li>
                    <li><a href="{% url 'setup:kernel_overview' %}">{% trans "Kernel overview" %}</a></li>
                    <li><a href="{% url 'setup:partition_overview' %}">{% trans "Partition overview" %}</a></li>
                </ul>
            </li>
            {% endif %}
            {% if csw_perms.backbone.group_admin %}
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Users" %} <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'user:overview' %}">{% trans "Overview" %}</a></li>
                </ul>
            </li>
            {% endif %}
            {% if settings.CLUSTER_LICENSE.monitor %}
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Monitoring" %} <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'mon:setup' %}">{% trans "Basic setup" %}</a></li>
                    <li><a href="{% url 'mon:device_config' %}">{% trans "Device settings" %}</a></li>
                    {% if settings.CLUSTER_LICENSE.monext %}
                        <li class="divider"></li>
                        <li><a href="{% url 'mon:setup_cluster' %}">{% trans "Cluster / Dependency setup" %}</a></li>
                        <li><a href="{% url 'mon:setup_escalation' %}">{% trans "Escalation setup" %}</a></li>
                    {% endif %}
                    <li class="divider"></li>
                    <li><a href="{% url 'mon:call_icinga' %}">{% trans "Icinga (replace)" %}</a></li>
                    <li><a href="{% url 'mon:call_icinga' %}" target="_blank">{% trans "Icinga (new tab)" %}</a></li>
                    {% if settings.CLUSTER_LICENSE.ganglia %}
                        <li><a href="/ganglia-web">{% trans "Ganglia" %}</a></li>
                    {% endif %}
                    <li class="text-center">
                        <input id="create_monitoring_config" type="button" class="btn btn-success" value="rebuild config" ng-click="rebuild_config()"/>
                    </li>
                </ul>
            </li>
            {% endif %}
            {% if settings.CLUSTER_LICENSE.rms %}
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown">{% trans "RMS" %} <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'rms:overview' %}">{% trans "RMS overview" %}</a></li>
                </ul>
            </li>
            {% endif %}
            {% if settings.DEBUG %}
            <li ng-show="0" class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown">{% trans "REST" %} <b class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'rest:root' %}">{% trans "REST API rootnode (for testing)" %}</a></li>
                </ul>
            </li>
            {% endif %}
            {% for add_menu in settings.ADDITIONAL_MENU_FILES %}
                {% include add_menu %}
            {% endfor %}
            <li class="visible-md visible-lg">
                {% verbatim %}
                <div ng-show="num_gauges" ng-repeat="(key, obj) in cur_gauges" class="progress" style="width:200px; margin-top:10px;">
                    <progressbar animate="true" value="obj.value" type="success"><span>{{ obj.value }} %</span></progressbar>
                </div>
                {% endverbatim %}
            </li>
            <li ng-if="num_gauges == 0" class="visible-md visible-lg">
                {% with "images/product/"|add:settings.INIT_PRODUCT_NAME|lower|add:"-flat-trans.png" as gfx_name %}
                <img height="42px" src="{% static gfx_name %}" ng-click="redirect_to_init()" title="{{ settings.INIT_PRODUCT_NAME }}" alt="{{ settings.INIT_PRODUCT_NAME }} logo">
                </img>
                {% endwith %}
            </li>
        </ul>
    </div>
    <ul class="nav navbar-nav navbar-right">
        <li>
            <p class="navbar-text  visible-md visible-lg"">
                <span>
                    {% verbatim %}{{ cur_time }}{% endverbatim %}
                    <span title="{{ user }}">user '{{ user.login }}'</span>{% ifnotequal user.login request.session.login_name %} (via alias {{ request.session.login_name }}){% endifnotequal %}
                </span>
            </p>
        </li>
        <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown">{% trans "Session" %} <b class="caret"></b></a>
            <ul class="dropdown-menu">
                <li><a href="{% url 'user:account_info' %}">{% trans "Account Info" %}</a></li>
                <li><a href="{% url 'session:logout' %}">{% trans "Logout" %}</a></li>
                <li><a href="{% url 'admin:index' %}">{% trans "Admin" %}</a></li>
            </ul>
        </li>
        <li>
            &nbsp;
        </li>
    </ul>
</nav>

<script type="text/javascript">

{% inlinecoffeescript %}

root = exports ? this

menu_module = angular.module("icsw.menu_app", ["ngSanitize", "ui.bootstrap"])

menu_controller = menu_module.controller("menu_base", ["$scope", "$timeout",
    ($scope, $timeout) ->
        $scope.progress_iters = 0
        $scope.cur_gauges = {}
        $scope.num_gauges = 0
        $scope.get_progress_style = (obj) ->
            return {"width" : "#{obj.value}%"}
        $scope.show_time = () ->
            $scope.cur_time = moment().format("ddd, Do MMMM YYYY HH:mm:ss")
            $timeout($scope.show_time, 1000)
        $scope.update_progress_bar = () ->
            $.ajax
                url     : "{% url 'base:get_gauge_info' %}",
                hidden  : true,
                success : (xml) =>
                    cur_pb = []
                    if parse_xml_response(xml)
                        $(xml).find("gauge_info gauge_element").each (idx, cur_g) ->
                            cur_g = $(cur_g)
                            idx = cur_g.attr("idx")
                            if idx of $scope.cur_gauges
                                $scope.cur_gauges[idx].info = cur_g.text()
                                $scope.cur_gauges[idx].value = parseInt(cur_g.attr("value"))
                            else
                                $scope.cur_gauges[idx] = {info : cur_g.text(), value : parseInt(cur_g.attr("value"))}
                            cur_pb.push(idx)
                    del_pbs = (cur_idx for cur_idx of $scope.cur_gauges when cur_idx not in cur_pb)
                    for del_pb in del_pbs
                        delete $scope.cur_gauges[del_pb]
                    #for cur_idx, value of $scope.cur_gauges
                    $scope.$apply(
                        $scope.num_gauges = cur_pb.length
                        if cur_pb.length or $scope.progress_iters
                            if $scope.progress_iters
                                $scope.progress_iters--
                            $timeout($scope.update_progress_bar, 1000)
                    )
        $scope.redirect_to_init = () ->
            window.location = "http://www.init.at"
            return false
        $scope.show_time()
        #$scope.update_progress_bar()
        $scope.rebuild_config = () ->
            $.ajax
                url     : "{% url 'mon:create_config' %}"
                title   : "create config"
                success : (xml) =>
                    if parse_xml_response(xml)
                        # make at least five iterations to catch slow startup of md-config-server
                        $scope.progress_iters = 5
                        $scope.update_progress_bar()
])

# bootstrap angular
angular.element(document).ready(() ->
    angular.bootstrap($("nav[id='icsw.menu_app']"), ["icsw.menu_app"])
)

{% endinlinecoffeescript %}

</script>

