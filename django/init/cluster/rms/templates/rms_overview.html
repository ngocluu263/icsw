{% extends "main.html" %}
{% load i18n extra_tags %}

{% block title %}{% trans "RMS Overview" %}{% endblock %}

{% block body %}

<h1 class="center">RMS Overview</h1>
<h2 class="center">Running jobs</h2>
<table id="run_job_table">
    <thead>
        <tr>
            {% for entry in run_job_headers %}
                <th>{{ entry.tag }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<h2 class="center">Waiting jobs</h2>
<table id="wait_job_table">
    <thead>
        <tr>
            {% for entry in wait_job_headers %}
                <th>{{ entry.tag }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<h2 class="center">Node list</h2>
<table id="node_table">
    <thead>
        <tr>
            {% for entry in node_headers %}
                <th>{{ entry.tag }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<input type="button" value="reload" onClick="reload_page();"/>, <a href="{% url session:login %}">Loginpage</a>

<script type="text/javascript">
function reload_page() {
    <!-- window.location.reload();-->
    $("#node_table").dataTable().fnDraw();
    $("#run_job_table").dataTable().fnDraw();
    $("#wait_job_table").dataTable().fnDraw();
};

function addHandlers() {
    $("#id_username").focus();
    $(document).everyTime(1000000, "reload_page", function(i) {
        reload_page();
    });
    $("#wait_job_table td").addClass("list");
    $("#wait_job_table tbody tr").mouseover(function() { $(this).addClass("highlight") ; }).mouseout(function() { $(this).removeClass("highlight") ; });
    $("#wait_job_table").tablesorter({widgets : ["zebra"]});
    $("#wait_job_table.tablesorter th").append("&nbsp;&nbsp;&nbsp;&nbsp;");
    $("#node_table").dataTable({
        "bProcessing"     : true,
        "bServerSide"     : true,
        "sAjaxSource"     : "{% url rms:get_node_xml %}",
        "sServerMethod"   : "POST",
        "bJQueryUI"       : true,
        "sPaginationType" : "full_numbers",
        "bStateSave"      : true,
        "bAutoWidth"      : false,
        "aoColumnDefs"    : [{
            "fnRender" : function(o, val) {
                return "<b>" + val + "</b>";
            },
            "aTargets" : [6, 7, 8],
            "sClass" : "center slots_info"
        }, {
            "fnRender" : function(o, val) {
                var cur_m = val.match(/(\d+\.\d+).*/);
                if (cur_m) {
                    var max_load = 16.;
                    load = Math.min(cur_m[0], max_load);
                    ret_el = $("<div>").addClass("leftfloat").append($("<b>").text($.sprintf("%3.2f", load))).after(
                        $("<div>").addClass("load_outer").append(
                        $("<div>").addClass("load_inner").css("width", parseInt(98 * load / max_load) + "px"))
                    );
                    console.log(ret_el);
                    return $("<div>").append(ret_el).html();
                } else {
                    return "<b>" + val + "</b>";
                };
            },
            "aTargets" : [5],
            "sClass" : "load"
        }]
    });
    $("#run_job_table").dataTable({
        "bProcessing"     : true,
        "bServerSide"     : true,
        "sAjaxSource"     : "{% url rms:get_run_jobs_xml %}",
        "sServerMethod"   : "POST",
        "bJQueryUI"       : true,
        "sPaginationType" : "full_numbers",
        "bStateSave"      : true,
        "bAutoWidth"      : false
    });
    $("#wait_job_table").dataTable({
        "bProcessing"     : true,
        "bServerSide"     : true,
        "sAjaxSource"     : "{% url rms:get_wait_jobs_xml %}",
        "sServerMethod"   : "POST",
        "bJQueryUI"       : true,
        "sPaginationType" : "full_numbers",
        "bStateSave"      : true,
        "bAutoWidth"      : false,
        "aoColumnDefs"    : [{
            "fnRender" : function(o, val) {
                return "<b>" + val + "</b>";
            },
            "aTargets" : [5],
            "sClass" : "center"
        }]
    });
    $("#test").dataTable();
}

$(document).ready(addHandlers);
</script>

{% endblock %}
