{% extends "main.html" %}

{% load i18n coffeescript %}

{% block title %}{% trans "Device tree" %}{% endblock %}

{% block content %}

<h1 class="center">Device tree</h1>

<div id="device_table">
</div>
<input type="button" value="reload" onclick="reload_device_tree();" />

<script type="text/javascript">

// tree xml
TREE_XML = undefined;

function change_device_group_cb(event) {
    submit_change($(event.target));
    // move row
    var cur_tr = $(event.target).parents("tr:first");
    var new_dg_tr = $("table#device_tree tr[id='devg__" + $(event.target).attr("value") + "']");
    cur_tr.insertAfter(new_dg_tr);
    cur_tr.attr({
        "id" : "dev__" + new_dg_tr.attr("id").split("__")[1] + "__" + cur_tr.attr("id").split("__")[2]
    });
    update_device_group_info(TREE_XML);
    // force unroll of device_groups
    toggle_device(new_dg_tr.attr("id").split("__")[1], true);
};

function change_sel_device_type_cb(event) {
    var new_dt = $(event.target).attr("value");
    $(event.target).attr("value", "0");
    $("table#device_tree input[id^='dev__'][id$='__sel']:checked").each(function() {
        var dev_pk = $(this).attr("id").split("__")[1];
        var targ_sel = $("table#device_tree select#dev__" + dev_pk + "__device_type");
        if (targ_sel.attr("value") != new_dt) targ_sel.attr("value", new_dt).trigger("change");
    });
};

function change_sel_device_group_cb(event) {
    var new_dg = $(event.target).attr("value");
    $(event.target).attr("value", "0");
    $("table#device_tree input[id^='dev__'][id$='__sel']:checked").each(function() {
        var dev_pk = $(this).attr("id").split("__")[1];
        var targ_sel = $("table#device_tree select#dev__" + dev_pk + "__device_group");
        if (targ_sel.attr("value") != new_dg) targ_sel.attr("value", new_dg).trigger("change");
    });
};

function change_sel_device_mother_cb(event) {
    var new_bs = $(event.target).attr("value");
    if (new_bs == "-1") new_bs = "0";
    $(event.target).attr("value", "0");
    $("table#device_tree input[id^='dev__'][id$='__sel']:checked").each(function() {
        var dev_pk = $(this).attr("id").split("__")[1];
        var targ_sel = $("table#device_tree select#dev__" + dev_pk + "__bootserver");
        if (targ_sel.attr("value") != new_bs) targ_sel.attr("value", new_bs).trigger("change");
    });
};

function change_sel_device_curl_cb(event) {
    var new_curl = $(event.target).attr("value");
    console.log(new_curl);
    $(event.target).attr("value", "");
    $("table#device_tree input[id^='dev__'][id$='__sel']:checked").each(function() {
        var dev_pk = $(this).attr("id").split("__")[1];
        var targ_sel = $("table#device_tree input#dev__" + dev_pk + "__curl");
        if (targ_sel.attr("value") != new_curl) targ_sel.attr("value", new_curl).trigger("change");
    });
};

function toggle_device_group_selection(event) {
    var cur_el = $(event.target);
    var cur_tr = cur_el.parents("tr:first");
    cur_tr.parents("table:first").find("tr[id^='dev__" + cur_tr.attr("id").split("__")[1] + "__']").each(function() {
        var dev_tr = $(this);
        var dev_sel = dev_tr.find("input[id$='__sel']");
        if (dev_sel.is(":checked")) {
            dev_sel.removeAttr("checked");
        } else {
            dev_sel.attr("checked", "checked");
        };
        dev_tr.show();
    });
};

function build_device_table(xml) {
    $("div#device_table").children().remove();
    new_table = $("<table>").attr({"id" : "device_tree"});
    // device_type metadevice
    var md_dt = $(xml).find("device_type[identifier='MD']").attr("pk");
    $(xml).find("device_group").each(function() {
        var cur_dg = $(this);
        var new_tr = $("<tr>").attr({
            "id"    : cur_dg.attr("key"),
            "class" : "ui-widget ui-widget-header"
        });
        // expandbox / name
        if (cur_dg.attr("is_cdg") == "1") {
            new_tr.append($("<th>"));
        } else {
            new_tr.append(
                $("<td>").append(
                    $("<div>").css({"float" : "left"}).attr({
                        "class"   : "ui-icon ui-icon-triangle-1-e",
                        "id"      : "expand_" + $(cur_dg).attr("pk")
                    }).bind("click", function(event) {
                        var cur_class = $(event.target).attr("class");
                        if (cur_class.match(/-1-e$/)) {
                            toggle_device(cur_dg.attr("pk"), true);
                        } else {
                            toggle_device(cur_dg.attr("pk"), false);
                        }
                    })
                ).append(
                    $("<input>").attr({
                        "type" : "checkbox"
                    }).bind("click", toggle_device_group_selection)
                )
            );
        };
        new_tr.append($("<th>").append(
            create_input_el(cur_dg, "name", "devg__" + cur_dg.attr("pk"))
        ));
        new_tr.append($("<th>").append(
            create_input_el(cur_dg, "description", "devg__" + cur_dg.attr("pk"))
        ));
        new_tr.append($("<th>").append(
            $("<span>").attr({
                "id" : "devg__" + cur_dg.attr("pk") + "__info"
            }).text("---"))
        );
        new_tr.append($("<th>").text(cur_dg.attr("is_cdg") == "1" ? "Cluster device group" : "device group"));
        new_tr.append($("<th>").text("motherserver"));
        new_tr.append($("<th>").text("cURL"));
        if (cur_dg.attr("is_cdg") == "1") {
            new_tr.append($("<th>"));
        } else {
            new_tr.append($("<th>").append(
                $("<input>").attr({
                    "type"  : "button",
                    "value" : "delete"
                }).bind("click", function(event) {
                    var data = {};
                    data["devg__" + cur_dg.attr("pk")] = "1"
                    if (confirm("really delete device_group " + cur_dg.attr("name") + " ?")) {
                        $.ajax({
                            url : "{% url base:delete_object 'device_group' %}",
                            data : data,
                            success : function(xml) {
                                if (parse_xml_response(xml)) {
                                    reload_device_tree(xml);
                                }
                            }
                        })
                    };
                })
            ));
        }
        new_table.append(new_tr);
        $(cur_dg).find("device[device_type!='" + md_dt + "']").each(function() {
            var cur_d = $(this);
            var new_tr = $("<tr>").attr({
                "id"    : "dev__" + cur_dg.attr("pk") + "__" + cur_d.attr("pk"),
                "class" : "ui-widget"
            });
            // name
            new_tr.append($("<td>").append(
                create_input_el(cur_d, "sel", "dev__" + cur_d.attr("pk"), {boolean : true, bind : false})
            ));
            new_tr.append($("<td>").append(
                create_input_el(cur_d, "name", "dev__" + cur_d.attr("pk"))
            ));
            // description / comment
            new_tr.append($("<td>").append(
                create_input_el(cur_d, "comment", "dev__" + cur_d.attr("pk"))
            ));
            // device_type
            new_tr.append($("<th>").append(
                create_input_el(cur_d, "device_type", "dev__" + cur_d.attr("pk"), {
                    select_source           : "device_types device_type[identifier!='MD']",
                    select_source_attribute : "name"
                })
            ));
            // device group
            new_tr.append($("<td>").append(
                create_input_el(cur_d, "device_group", "dev__" + cur_d.attr("pk"), {
                    select_source           : "response device_group[is_cdg='0']",
                    select_source_attribute : "name",
                    change_cb               : change_device_group_cb
                })
            ));
            // mother server
            new_tr.append($("<td>").append(
                create_input_el(cur_d, "bootserver", "dev__" + cur_d.attr("pk"), {
                    select_source  : "mother_servers mother_server",
                    add_null_entry : "not set"
                })
            ));
            // cULR
            new_tr.append($("<td>").append(
                create_input_el(cur_d, "curl", "dev__" + cur_d.attr("pk"))
            ));
            // device_group, cdg is not an option
            new_tr.append($("<td>").append(
                $("<input>").attr({
                    "type"  : "button",
                    "value" : "delete",
                    "id"    : "dev__del__" + cur_d.attr("pk")
                }).bind("click", function(event, param) {
                    if (param == "noask" || confirm("really delete device " + cur_d.attr("name") + " ?")) {
                        data = {};
                        data["dev__" + cur_d.attr("pk")] = "1"
                        $.ajax({
                            url : "{% url base:delete_object 'device' %}",
                            data : data,
                            success : function(xml) {
                                if (parse_xml_response(xml)) {
                                    $(event.target).parents("tr:first").remove();
                                    update_device_group_info(xml);
                                }
                            }
                        })
                    };
                })
            ));
            new_table.append(new_tr);
            new_tr.hide();
        });
    });
    // new device group
    var new_tr = $("<tr>").attr({
        "id"    : "new_dg",
        "class" : "ui-widget ui-widget-header"
    }).append(
        $("<th>").append("new DevGroup")
    ).append(
        $("<th>").append(
            create_input_el(undefined, "name", "new__device_group")
        )
    );
    new_tr.append($("<th>").append(
        create_input_el(undefined, "description", "new__device_group")
    ));
    new_tr.append($("<th>").attr({"colspan" : "4"}));
    new_tr.append($("<th>").append(
        $("<input>").attr({
            "type"  : "button",
            "value" : "create"
        }).bind("click", function(event) {
            $.ajax({
                url : "{% url base:create_object 'device_group' %}",
                data : {
                    "devg__new"              : 1,
                    "devg__new__name"        : $("table tr#new_dg input#new__device_group__name").attr("value"),
                    "devg__new__description" : $("table tr#new_dg input#new__device_group__description").attr("value")
                },
                success : function(xml) {
                    if (parse_xml_response(xml)) {
                        reload_device_tree(xml);
                    }
                }
            })
        })
    ));
    new_table.append(new_tr);
    // new device
    var new_tr = $("<tr>").attr({
        "id"    : "new_dev",
        "class" : "ui-widget ui-widget-header"}).append(
        $("<th>").append("new Device")).append(
        $("<th>").append(
            create_input_el(undefined, "name", "new")
    ));
    new_tr.append($("<th>").append(
        create_input_el(undefined, "comment", "new")
    ));
    new_tr.append($("<th>").append(
        create_input_el(undefined, "device_type", "new", {
            select_source           : "device_types device_type[identifier!='MD']",
            select_source_attribute : "name"
        })
    ));
    new_tr.append($("<th>").append(
        create_input_el(undefined, "device_group", "new", {
            select_source           : "response device_group[is_cdg='0']",
            select_source_attribute : "name"
        })
    ));
    // mother server
    new_tr.append($("<th>").append(
        create_input_el(undefined, "bootserver", "new", {
            select_source  : "mother_servers mother_server",
            add_null_entry : "not set"
        })
    ));
    // cURL
    new_tr.append($("<th>").append(
        create_input_el(undefined, "curl", "new", {
            new_default : "ssh://"
        })
    ));
    new_tr.append($("<th>").append(
        $("<input>").attr({
            "type"  : "button",
            "value" : "create"
        }).bind("click", function(event) {
            $(event.target).attr("disabled", "disabled");
            $.ajax({
                url : "{% url base:create_object 'device' %}",
                data : {
                    "dev__new"               : 1,
                    "dev__new__name"         : $("table tr#new_dev input#new__name").attr("value"),
                    "dev__new__comment"      : $("table tr#new_dev input#new__comment").attr("value"),
                    "dev__new__device_type"  : $("table tr#new_dev select#new__device_type").attr("value"),
                    "dev__new__device_group" : $("table tr#new_dev select#new__device_group").attr("value"),
                    "dev__new__bootserver"   : $("table tr#new_dev select#new__bootserver").attr("value"),
                    "dev__new__curl"         : $("table tr#new_dev input#new__curl").attr("value")
                },
                success : function(xml) {
                    $(event.target).removeAttr("disabled");
                    if (parse_xml_response(xml)) {
                        reload_device_tree(xml);
                    }
                }
            })
        })
    ));
    new_table.append(new_tr);
    // selected devices
    var new_tr = $("<tr>").attr({
        "id"    : "sel_dev",
        "class" : "ui-widget ui-widget-header"}).append($("<th>").attr({"colspan" : "3"}).append("action on selected devices"));
    new_tr.append($("<th>").append(
        create_input_el(undefined, "type", "sel_device__", {
            select_source           : "device_types device_type[identifier!='MD']",
            select_source_attribute : "name",
            add_null_entry          : "-- keep --",
            change_cb               : change_sel_device_type_cb
        })
    ));
    new_tr.append($("<th>").append(
        create_input_el(undefined, "group", "sel_device__", {
            select_source           : "response device_group[is_cdg='0']",
            select_source_attribute : "name",
            add_null_entry          : "-- keep --",
            change_cb               : change_sel_device_group_cb
        })
    ));
    new_tr.append($("<th>").append(
        create_input_el(undefined, "mother", "sel_device__", {
            select_source           : "mother_servers mother_server",
            add_extra_entry         : "-- clear --",
            add_null_entry          : "-- keep --",
            change_cb               : change_sel_device_mother_cb
        })
    ));
    new_tr.append($("<th>").append(
        create_input_el(undefined, "curl", "sel_device__", {
            change_cb : change_sel_device_curl_cb
        })
    ));
    new_tr.append($("<td>").append(
        $("<input>").attr({
            "type"  : "button",
            "value" : "delete"
        }).bind("click", function(event) {
            var sel_list = $("table#device_tree input[id^='dev__'][id$='__sel']:checked");
            if (sel_list.length) {
                if (confirm("really delete selected " + sel_list.length + " devices ?")) {
                    $(sel_list).each(function() {
                        var cur_sel = $(this);
                        cur_sel.parents("tr:first").find("input[value='delete']").trigger("click", ["noask"]);
                    })
                };
            };
        })
    ));
    new_table.append(new_tr);
    $("div#device_table").append(new_table);
    update_device_group_info(xml);
    new_table.find("tr").mouseover(function() { $(this).addClass("highlight") ; }).mouseout(function() { $(this).removeClass("highlight") ; });
    new_table.find("input#new__device_name").focus();
};

function propagate_dg_changes(cur_el) {
    // set new device_group names on all selects
    $("table#device_tree select[id*='__device_group'] option[value='" + cur_el.parents("tr:first").attr("id").split("__")[1] + "']").each(function() {
        $(this).text(cur_el.attr("value"));
    });
};

function toggle_device(dg_pk, state) {
    var cur_dg = $("table#device_tree tr[id='devg__" + dg_pk + "'] div[id='expand_" + dg_pk + "']");
    if (state) {
        cur_dg.removeClass("ui-icon-triangle-1-e ui-icon-triangle-1-s");
        cur_dg.addClass("ui-icon-triangle-1-s");
        $("table#device_tree tr[id^='dev__" + dg_pk + "__']").show();
        recolor_device_group(dg_pk);
    } else {
        cur_dg.removeClass("ui-icon-triangle-1-e ui-icon-triangle-1-s");
        cur_dg.addClass("ui-icon-triangle-1-e");
        $("table#device_tree tr[id^='dev__" + dg_pk + "__']").hide();
    };
};

function recolor_device_group(dg_pk) {
    $("table#device_tree tr[id^='dev__" + dg_pk + "__']:even").removeClass("even odd");
    $("table#device_tree tr[id^='dev__" + dg_pk + "__']:even").addClass("even");
    $("table#device_tree tr[id^='dev__" + dg_pk + "__']:odd").addClass("odd");
};

function update_device_group_info(xml) {
    if ($(xml).find("device_group[is_cdg='0']").length == 0) {
        $("table tr[id='new_dev']").hide();
    } else {
        $("table tr[id='new_dev']").show();
    };
    $("table#device_tree tr[id^='devg__']").each(function() {
        var cur_tr = $(this);
        var dg_pk = cur_tr.attr("id").split("__")[1];
        recolor_device_group(dg_pk);
        var info_th = cur_tr.find("span[id^='devg__'][id$='__info']");
        var num_devs = $("table#device_tree tr[id^='dev__" + dg_pk + "__']").length;
        info_th.text(num_devs + " device" + (num_devs == 1 ? "" : "s"));
    });
};

function reload_device_tree() {
    $.ajax({
        url     : "{% url device:get_xml_tree %}",
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
                TREE_XML = $(xml);
                init_xml_change($(xml));
                build_device_table(xml);
            }
        }
    })
};

function add_dt_handlers() {
    init_xml_change($("<dummy>"));
    reload_device_tree();
};

$(document).ready(add_dt_handlers);

</script>

{% endblock %}
