{% extends "main.html" %}

{% load i18n extra_tags coffeescript %}

{% block title %}Cluster networks{% endblock %}

{% block content %}

<h1>Networks</h1>

<div id="nw_tables"></div>

<script type="text/javascript">

{% inlinecoffeescript %}

root = exports ? this

root.get_master_networks = (cur_el, kwargs) ->
    master_xml = kwargs.master_xml
    prod_id = master_xml.find("network_types network_type[identifier='p']").attr("pk")
    ret_field = $("<networks>")
    master_xml.find("networks network[network_type='#{prod_id}']").each (index, element) =>
        cur_nw = $(element)
        ret_field.append(
            $("<network>").attr({
                "pk"  : cur_nw.attr("pk"),
                "key" : cur_nw.attr("key")
            }).text(cur_nw.text())
        )
    return ret_field.find("network")

add_config_handlers = ->
    $.ajax
        url     : "{% url 'network:show_networks' %}"
        success : (xml) =>
            if parse_xml_response(xml)
                xml = $(xml).find("value[name='response']")
                other_network_id = xml.find("network_type[identifier='o']").attr("pk")
                ethernet_id = xml.find("network_device_type[identifier='eth']").attr("pk")
                master_array = {
                    "nw" : new draw_setup("Network", "nw", "network",
                        "{% url 'base:create_object' 'network' %}",
                        "{% url 'base:delete_object' 'network' %}",
                        [
                            new draw_collapse("exp", {default : false}),
                            new draw_info("identifier"),
                            new draw_info("network", {default : "192.168.1.0", size : 16, label : "Network", show_label : true, group : "network"}),
                            new draw_info("netmask", {default : "255.255.255.0", size : 16, label : "Netmask", show_label : true, group : "network"}),
                            new draw_info("broadcast", {default : "192.168.1.255", size : 16, label : "Broadcast", show_label : true, group : "network"}),
                            new draw_info("gateway", {default : "192.168.1.1", size : 16, label : "Gateway", show_label : true, group : "network"}),
                            new draw_info("ip_count", {number : 1, ro : true}),
                            new draw_info("penalty", {number : 1, min : -100, max : 100, default : 1, newline : 1, cspan : 8, label : "penalty:", show_label : true}),
                            new draw_info("network_type", {select_source : "network_types network_type", keep_td : 1, label : "type:", show_label : true, default : other_network_id} ),
                            new draw_info("master_network", {select_source : root.get_master_networks, add_null_entry : "not set", keep_td : 1, label : "master:", show_label : true} ),
                            new draw_info("network_device_type", {select_source : "network_device_types network_device_type", manytomany : 1, show_label : true, label : "DTs :", keep_td : 1, default : [ethernet_id]}),
                        ],
                        {"lock_div" : "nw_tables"})
                }
                
                draw_ds_tables($("div#nw_tables"), master_array, xml)

$(document).ready(add_config_handlers)

{% endinlinecoffeescript %}

</script>

{% endblock %}
