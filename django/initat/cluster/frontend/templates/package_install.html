{% extends "main.html" %}

{% load i18n compress %}

{% block title %}{% trans "Package Install" %}{% endblock %}


{% block content %}

<h1 class="center">Package Install</h1>

<div id="device"></div>

<div id="package"></div>

<script type="text/javascript">

// Package XML
PACKAGE_XML = undefined;
// Devices XML
DEVICE_XML = undefined;

var master_array = {
    "pack" : new draw_setup("Packages", "pack", "package",
        undefined,
        undefined,
        [
            new draw_info("name", {size : 40}),
            new draw_info("version", {size : 40}),
            new draw_info("kind", {size : 20}),
            new draw_info("arch", {size : 20}),
            new draw_info("package_repo", {select_source : "package_repos package_repo"}),
            new draw_info("tstate", {change_cb : change_target_state, select_source : "target_states target_state", trigger : true, add_null_entry : "---"}),
            new draw_info("add", {change_cb : add_package, button : true, trigger : true}),
            new draw_info("remove", {change_cb : remove_package, button : true, trigger : true}),
            new draw_info("delete", {change_cb : delete_package, button : true, trigger : true}),
        ], {
            lock_div : "package"
        }
    )
};

function use_devs(dt_div) {
    CUR_DEVICES = _.map(dt_div.dynatree("getSelectedNodes"), function(value) {
        return(value.data.key);
    });
    load_devices(CUR_DEVICES);
};

function load_devices(sel_list) {
    //console.log(sel_list);
    $.ajax({
        url     : "{% url device:get_group_tree %}",
        error   : handle_ajax_error,
        data    : {
            "sel_list"            : sel_list,
            "ignore_meta_devices" : 1,
            "extra_t0"            : "package_device_connection",
            "extra_t0_device"     : 1
        },
        success : function(xml) {
            if (parse_xml_response(xml)) {
                DEVICE_XML = $(xml).find("value[name='response']");
                draw_device_table();
            }
        }
    });
};

function change_target_state(event) {
    var cur_el = $(event.target);
    var pack_key = cur_el.attr("id").split("__").slice(0, 2).join("__");
    var pack_pk = pack_key.split("__")[1];
    var t_state = cur_el.val();
    if (t_state != "0") {
        cur_el.val("0");
        $("table#device").find("tr[id^='pdc__'] ").each(function(idx) {
            var cur_tr = $(this);
            if (DEVICE_XML.find("package_device_connections package_device_connection[pk='" + cur_tr.attr("id").split("__")[1] + "'][package='" + pack_pk + "']").length) {
                if (cur_tr.find("input[id$='__sel']:checkbox:checked").length) {
                    var cur_sel = cur_tr.find("select[id$='__tstate']");
                    cur_sel.val(t_state).trigger("change");
                };
            };
        });
    };
};

function remove_package(event) {
    var cur_el = $(event.target);
    var pack_key = cur_el.attr("id").split("__").slice(0, 2).join("__");
    var pack_pk = pack_key.split("__")[1];
    var d_table = $("table#device");
    // get all devices which have the current package not set
    DEVICE_XML.find("device_group devices device[meta_device='0']").each(function() {
        var dev_xml = $(this);
        var dev_key = dev_xml.attr("key");
        // device is select
        if (d_table.find("input[id='" + dev_key + "__sel']").prop("checked")) {
            var cur_pdc = DEVICE_XML.find("package_device_connections package_device_connection[package='" + pack_pk + "'][device='" + dev_xml.attr("pk") + "']");
            if (cur_pdc.length) {
                remove_package_xml(cur_pdc);
            };
        };
    });
};

function remove_package_xml(cur_pdc) {
    $.ajax({
        url     : "{% url pack:remove_package %}",
        data    : {
            "pdc_key"  : cur_pdc.attr("key")
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
                $("table#device").find("tr[id='" + cur_pdc.attr("key") + "']").remove();
                DEVICE_XML.find("package_device_connections package_device_connection[key='" + cur_pdc.attr("key") + "']").remove();
            }
        }
    });
};

function add_package(event) {
    var cur_el = $(event.target);
    var pack_key = cur_el.attr("id").split("__").slice(0, 2).join("__");
    var pack_pk = pack_key.split("__")[1];
    var d_table = $("table#device");
    // get all devices which have the current package not set
    DEVICE_XML.find("device_group devices device[meta_device='0']").each(function() {
        var dev_xml = $(this);
        var dev_key = dev_xml.attr("key");
        // device is select
        if (d_table.find("input[id='" + dev_key + "__sel']").prop("checked")) {
            if (!DEVICE_XML.find("package_device_connections package_device_connection[package='" + pack_pk + "'][device='" + dev_xml.attr("pk") + "']").length) {
                add_package_xml(dev_xml, PACKAGE_XML.find("package[key='" + pack_key + "']"));
            };
        };
    });
};

function add_package_xml(dev_xml, pack_xml) {
    $.ajax({
        url     : "{% url pack:add_package %}",
        data    : {
            "dev_key"  : dev_xml.attr("key"),
            "pack_key" : pack_xml.attr("key")
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
                var new_pdc = $(xml).find("value[name='new_entry'] package_device_connection");
                DEVICE_XML.find("package_device_connections").append(new_pdc);
                $("table#device").find("tr[id='" + dev_xml.attr("key") + "']").after(
                    draw_pdc(dev_xml, new_pdc)
                );
            }
        }
    });
};

function delete_package(event) {
    var targ_el = $(event.target);
    if (confirm("really delete package ?")) {
        $.ajax({
            url     : "{% url pack:remove_package %}",
            data    : {
                "pk" : targ_el.attr("id").split("__")[1]
            },
            error   : handle_ajax_error,
            success : function(xml) {
                if (parse_xml_response(xml)) {
                    targ_el.parents("tr:first").remove();
                }
            }
        });
    };
};

function draw_tstate(pdc_xml) {
    var cur_ts = $("<select>").attr({
        "id" : pdc_xml.attr("key") + "__tstate"
    });
    PACKAGE_XML.find("target_states target_state").each(function(key) {
        var value = $(this).attr("pk");
        var cur_opt = $("<option>").attr({"value" : cur_opt}).text(value);
        if (pdc_xml.attr("target_state") == value) cur_opt.attr("selected", "selected");
        cur_ts.append(cur_opt);
    });
    cur_ts.bind("change", function(event) {
        var cur_el = $(event.target);
        $.ajax({
            url   : "{% url pack:change_target_state %}",
            data  : {
                "pdc_key" : cur_el.attr("id"),
                "value"   : cur_el.val()
            },
            success : function(xml) {
                if (parse_xml_response(xml)) {
                }
            }
        });
    });
    return cur_ts;
};

function draw_pflag(pdc_xml, flag_name) {
    var cur_ts = $("<input>").attr({
        "type" : "checkbox",
        "id"   : pdc_xml.attr("key") + "__" + flag_name});
    if (pdc_xml.attr(flag_name) == "1") cur_ts.attr("checked", "checked");
    cur_ts.bind("change", function(event) {
        var cur_el = $(event.target);
        $.ajax({
            url   : "{% url pack:change_package_flag %}",
            data  : {
                "pdc_key" : cur_el.attr("id"),
                "value"   : cur_el.prop("checked") ? "1" : "0"
            },
            success : function(xml) {
                if (parse_xml_response(xml)) {
                }
            }
        });
    });
    return cur_ts;
};

function draw_pdc(dev_xml, pdc_xml) {
    var line_prefix = pdc_xml.attr("key");
    var pack_xml = PACKAGE_XML.find("packages package[pk='" + pdc_xml.attr("package") + "']");
    var new_tr = $("<tr>").attr({
        "class" : "ui-widget ui-widget-header",
        "id"    : line_prefix
    });
    new_tr.append(
        $("<td>").append(
            $("<input>").attr({
                "type" : "checkbox",
                "id"   : pdc_xml.attr("key") + "__sel"
            })
        )
    ).append(
        $("<td>").text(pack_xml.text())
    ).append(
        $("<td>").text(pack_xml.attr("version"))
    ).append(
        $("<td>").text(pack_xml.attr("arch"))
    ).append(
        $("<td>").append(draw_tstate(pdc_xml))
    ).append(
        $("<td>").text(pdc_xml.attr("installed"))
    ).append(
        $("<td>").append(draw_pflag(pdc_xml, "force_flag"))
    ).append(
        $("<td>").append(draw_pflag(pdc_xml, "nodeps_flag"))
    );
    return new_tr;
};

function draw_device(d_el) {
    var dummy_div = $("<div>");
    var line_prefix = d_el.attr("key");
    var new_tr = $("<tr>").attr({
        "class" : "ui-widget ui-widget-header",
        "id"    : line_prefix
    });
    new_tr.append(
        $("<td>").append(
            $("<input>").attr({
                "type" : "checkbox",
                "id"   : line_prefix + "__sel"
            })
        ).bind("change", change_d_sel)
    ).append(
        $("<td>").attr({
        }).text("device " + d_el.text())
    );
    dummy_div.append(new_tr);
    DEVICE_XML.find("package_device_connections package_device_connection[device='" + d_el.attr("pk") + "']").each(function() {
        var pdc_xml = $(this);
        dummy_div.append(draw_pdc(d_el, pdc_xml));
    });
    return dummy_div.children();
    
};

function draw_device_table() {
    d_table = $("<table>").attr({"id" : "device"});
    DEVICE_XML.find("device_group").each(function() {
        var cur_dg = $(this);
        var new_tr = $("<tr>").attr({
            "class"   : "ui-widget ui-widget-header"
        });
        var line_prefix = cur_dg.attr("key");
        new_tr.append(
            $("<th>").append(
                $("<input>").attr({
                    "type" : "checkbox",
                    "id"   : line_prefix + "__sel"
                }).bind("click", change_dg_sel)
            )
        ).append($("<th>").attr({
            "colspan" : "5"
        }).addClass("ui-widget ui-widget-header").text("device group " + cur_dg.attr("name")));
        d_table.append(new_tr);
        cur_dg.find("devices device[selected='selected'][meta_device='0']").each(function() {
            var cur_dev = $(this);
            d_table.append(draw_device(cur_dev));
        });
    });
    var d_div = $("div#device");
    d_div.children().remove();
    d_div.append(d_table);
    d_div.append($("<span>").text("selection: "));
    d_div.append($("<input>").attr({
        "type"  : "button",
        "value" : "toggle"
    }).bind("click", change_global_sel));
};

function change_global_sel(event) {
    var d_table = $("table#device");
    DEVICE_XML.find("device_group").each(function() {
        var cur_dg = $(this);
        var sel_box = d_table.find("input[id='" + cur_dg.attr("key") + "__sel']");
        sel_box.trigger("click");
    });
};

function change_dg_sel(event) {
    var cur_el = $(event.target);
    var d_table = $("table#device");
    DEVICE_XML.find("device_group[key='" + cur_el.attr("id").split("__").slice(0, 2).join("__") + "'] devices device[selected='selected']").each(function() {
        var cur_dev = $(this);
        var sel_box = d_table.find("input[id='" + cur_dev.attr("key") + "__sel']");
        sel_box.trigger("click");
    });
};

function change_d_sel(event) {
    var cur_el = $(event.target);
    var d_table = $("table#device");
    var sel_tr = cur_el.parents("tr:first");
    while (true) {
        var sel_tr = sel_tr.next();
        if (sel_tr && sel_tr.attr("id") && sel_tr.attr("id").match(/^pdc__/)) {
            sel_tr.find("input[id$='__sel']").trigger("click");
        } else {
            break;
        };
    };
};

function draw_package_table() {
    var t_div = $("div#package");
    t_div.children().remove();
    for (var key in master_array) {
        t_div.append(master_array[key].draw_table());
    };
};

function load_packages() {
    $.ajax({
        url     : "{% url pack:install %}",
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
                PACKAGE_XML = $(xml).find("value[name='response']");
                init_xml_change(PACKAGE_XML);
                draw_package_table();
            }
        }
    });
}

function add_install_handlers() {
    load_packages();
    install_devsel_link(use_devs, true);
};

$(document).ready(add_install_handlers);

</script>

{% endblock %}
