{% extends "main.html" %}

{% load i18n compress coffeescript %}

{% block title %}{% trans "Package Install" %}{% endblock %}


{% block content %}

<h1 class="center">Package Install</h1>

<div id="device"></div>

<div id="package"></div>

<script type="text/javascript">

{% inlinecoffeescript %}

class device_table
    constructor: (@xml) ->
    build_table: (@top_div, @sel_list) =>
        $.ajax
            url     : "{% url 'pack:install' %}"
            error   : handle_ajax_error
            success : (xml) =>
                if parse_xml_response(xml)
                    @pack_xml = $(xml).find("value[name='response']")
                    master_array = {
                        "pack" : new draw_setup("Packages", "pack", "package",
                            undefined,
                            undefined,
                            [
                                new draw_info("name", {size : 40}),
                                new draw_info("version", {size : 40}),
                                new draw_info("kind", {size : 20}),
                                new draw_info("arch", {size : 20}),
                                new draw_info("package_repo", {select_source : "package_repos package_repo"}),
                                new draw_info("tstate", {change_cb : @change_target_state, select_source : "target_states target_state", trigger : true, add_null_entry : "---"}),
                                new draw_info("add", {change_cb : @add_package, button : true, trigger : true}),
                                new draw_info("remove", {change_cb : @remove_package, button : true, trigger : true}),
                                new draw_info("delete", {change_cb : @delete_package, button : true, trigger : true}),
                            ], {
                                lock_div : "package"
                            }
                        )
                    }
                    draw_ds_tables($("div#package"), master_array, @pack_xml)
                    @load_packages()
                    $(document).everyTime(5000, "refresh_package_info", @refresh_package_info)
    refresh_package_info: =>
        $.ajax
            url     : "{% url 'pack:refresh' %}"
            error   : handle_ajax_error
            data    : {"sel_list" : @sel_list}
            success : (xml) =>
                if parse_xml_response(xml)
                    $(xml).find("package_device_connection").each (index, cur_pdc) =>
                        cur_pdc = $(cur_pdc)
                        @xml.find("package_device_connections package_device_connection[key='" + cur_pdc.attr("key") + "']").attr("installed", cur_pdc.attr("installed"))
                        @table.find("span#" + cur_pdc.attr("key") + "__installed").text(cur_pdc.attr("installed"))
                    @update_device_info()
    change_target_state: (event) =>
        cur_el = $(event.target)
        pack_key = cur_el.attr("id").split("__")[0...2].join("__")
        pack_pk = pack_key.split("__")[1]
        t_state = cur_el.val()
        if t_state != "0"
            cur_el.val("0");
            @table.find("tr[id^='pdc__'] ").each (idx, cur_tr) =>
                cur_tr = $(cur_tr)
                if @xml.find("package_device_connections package_device_connection[pk='" + cur_tr.attr("id").split("__")[1] + "'][package='" + pack_pk + "']").length
                    if cur_tr.find("input[id$='__sel']:checkbox:checked").length
                        cur_sel = cur_tr.find("select[id$='__tstate']")
                        cur_sel.val(t_state).trigger("change")
    remove_package: (event) =>
        cur_el = $(event.target)
        if confirm("really remove package ?")
            pack_key = cur_el.attr("id").split("__")[0...2].join("__")
            pack_pk = pack_key.split("__")[1]
            # get all devices which have the current package not set
            @xml.find("device_group devices device[meta_device='0']").each (index, dev_xml) =>
                dev_xml = $(dev_xml)
                dev_key = dev_xml.attr("key")
                # device is selected
                if @table.find("input[id='" + dev_key + "__sel']").prop("checked")
                    cur_pdc = @xml.find("package_device_connections package_device_connection[package='" + pack_pk + "'][device='" + dev_xml.attr("pk") + "']")
                    if cur_pdc.length
                        @remove_package_xml(cur_pdc)
    remove_package_xml: (cur_pdc) =>
        $.ajax
            url     : "{% url 'pack:remove_package' %}"
            data    : {
                "pdc_key" : cur_pdc.attr("key")
            }
            error   : handle_ajax_error
            success : (xml) =>
                if parse_xml_response(xml)
                    @table.find("tr[id='" + cur_pdc.attr("key") + "']").remove()
                    @xml.find("package_device_connections package_device_connection[key='" + cur_pdc.attr("key") + "']").remove()
                    @update_device_info()
    add_package: (event) =>
        cur_el = $(event.target)
        pack_key = cur_el.attr("id").split("__")[0...2].join("__")
        pack_pk = pack_key.split("__")[1]
        @xml.find("device_group devices device[meta_device='0']").each (idx, dev_xml) =>
            dev_xml = $(dev_xml)
            dev_key = dev_xml.attr("key")
            if @table.find("input[id='" + dev_key + "__sel']").prop("checked")
                if not @xml.find("package_device_connections package_device_connection[package='" + pack_pk + "'][device='" + dev_xml.attr("pk") + "']").length
                    @add_package_xml(dev_xml, @pack_xml.find("package[key='" + pack_key + "']"))
    add_package_xml: (dev_xml, pack_xml) =>
        $.ajax
            url     : "{% url 'pack:add_package' %}"
            data    : {
                "dev_key"  : dev_xml.attr("key")
                "pack_key" : pack_xml.attr("key")
            },
            error   : handle_ajax_error
            success : (xml) =>
                if parse_xml_response(xml)
                    new_pdc = $(xml).find("value[name='new_entry'] package_device_connection")
                    @xml.find("package_device_connections").append(new_pdc)
                    @table.find("tr[id='" + dev_xml.attr("key") + "']").after(
                        @draw_pdc(dev_xml, new_pdc)
                    )
                    @update_device_info()
    delete_package: (event) =>
        targ_el = $(event.target)
        if confirm("really delete package ?")
            $.ajax
                url     : "{% url 'pack:unuse_package' %}"
                data    : {
                    "pk" : targ_el.attr("id").split("__")[1]
                }
                error   : handle_ajax_error
                success : (xml) =>
                    if parse_xml_response(xml)
                        targ_el.parents("tr:first").remove()
    load_packages: () =>
        d_table = $("<table>").attr({"id" : "device"})
        @table = d_table
        @dev_exp_state = {}
        @xml.find("device_group").each (index, cur_dg) =>
            d_table.append(@draw_device_group($(cur_dg)))
        @update_device_info()
        @top_div.children().remove()
        @top_div.append(d_table)
        @top_div.append(
            $("<span>").text("selection: ")
        ).append(
            $("<input>").attr({
                "type"  : "button",
                "value" : "toggle"
            }).bind("click", @change_global_sel)
        ).append(
            $("<input>").attr({
                "type"  : "button",
                "value" : "clear"
            }).bind("click", @clear_all_sel)
        ).append(
            $("<input>").attr({
                "type"  : "button",
                "value" : "all"
            }).bind("click", @set_all_sel)
        ).append(
            $("<span>").text(", server: ")
        ).append(
            $("<input>").attr({
                "type"  : "button",
                "value" : "synchronize"
            }).bind("click", @sync_server)
        )
    draw_device_group: (cur_dg) =>
        dummy_div = $("<div>")
        new_tr = $("<tr>").attr({
            "class"   : "ui-widget ui-widget-header"
        })
        line_prefix = cur_dg.attr("key")
        new_tr.append(
            $("<th>").append(
                $("<input>").attr({
                    "type" : "checkbox",
                    "id"   : line_prefix + "__sel"
                }).bind("click", (event) =>
                    @change_dg_sel(event)
                )
            )
        ).append($("<th>").attr({
            "colspan" : 9
        }).addClass("ui-widget ui-widget-header").text("device group " + cur_dg.attr("name")))
        dummy_div.append(new_tr)
        cur_dg.find("devices device[tree_selected='selected'][meta_device='0']").each (index, cur_dev) =>
            dummy_div.append(@draw_device($(cur_dev)))
        return dummy_div.children()
    update_device_info: () =>
        @table.find("tr[id^='dev__']").each (index, dev_tr) =>
            dev_tr = $(dev_tr)
            dev_pk = dev_tr.attr("id").split("__")[1]
            @recolor_device(dev_tr)
            info_th = dev_tr.find("span[id$='__pinfo']")
            pdc_list = @xml.find("package_device_connections package_device_connection[device='" + dev_pk + "']")
            total = pdc_list.length
            installed = removed = 0
            for cur_entry in pdc_list
                switch $(cur_entry).attr("installed")
                    when "y"
                        installed++
                    when "n"
                        removed++
            info_th.text(", " + total + " total, " + installed + " installed, " + removed + " removed")
    recolor_device: (dev_tr) =>
        pdc_lines = @get_pdc_lines(dev_tr)
        (line.removeClass("even odd") for line in pdc_lines)
        (line.addClass("even") for line in pdc_lines by 2)
        (line.addClass("odd") for line in pdc_lines[1..] by 2)
    clear_all_sel: (event) =>
        # at first clear all device groups
        @table.find("input[id^='devg__'][id$='__sel']:checked").each (index, cur_el) =>
            $(cur_el).trigger("click")
        # then clear all devices
        @table.find("input[id^='dev__'][id$='__sel']:checked").each (index, cur_el) =>
            $(cur_el).trigger("click")
        # then all pdcs
        @table.find("input[id^='pdc__'][id$='__sel']:checked").each (index, cur_el) =>
            $(cur_el).trigger("click")
    set_all_sel: (event) =>
        # at first set all device groups
        @table.find("input[id^='devg__'][id$='__sel']:not(:checked)").each (index, cur_el) =>
            $(cur_el).trigger("click")
        # then set all devices
        @table.find("input[id^='dev__'][id$='__sel']:not(:checked)").each (index, cur_el) =>
            $(cur_el).trigger("click")
        # then all pdcs
        @table.find("input[id^='pdc__'][id$='__sel']:not(:checked)").each (index, cur_el) =>
            $(cur_el).trigger("click")
    sync_server: (event) =>
        $.ajax
            url     : "{% url 'pack:synchronize' %}"
            error   : handle_ajax_error
            success : (xml) =>
                parse_xml_response(xml)
    change_global_sel: (event) =>
        @xml.find("device_group").each (idx, cur_dg) =>
            cur_dg = $(cur_dg)
            @table.find("input[id='" + cur_dg.attr("key") + "__sel']").trigger("click")
    change_dg_sel: (event) =>
        cur_el = $(event.target)
        @xml.find("device_group[key='" + cur_el.attr("id").split("__")[0...2].join("__") + "'] devices device[tree_selected='selected']").each (idx, cur_dev) =>
            cur_dev = $(cur_dev)
            @table.find("input[id='" + cur_dev.attr("key") + "__sel']").trigger("click")
    change_d_sel: (event) =>
        cur_el = $(event.target)
        (line.find("input[id$='__sel']").trigger("click") for line in @get_pdc_lines(cur_el.parents("tr:first")))
    get_pdc_lines: (dev_tr) =>
        tr_list = []
        while true
            dev_tr = dev_tr.next()
            if dev_tr and dev_tr.attr("id") and dev_tr.attr("id").match(/^pdc__/)
                tr_list.push(dev_tr)
            else
                break
        return tr_list
    draw_device: (cur_dev) =>
        dummy_div = $("<div>")
        line_prefix = cur_dev.attr("key")
        new_tr = $("<tr>").attr({
            "class" : "ui-widget ui-widget-header"
            "id"    : line_prefix
        })
        new_tr.append(
            $("<td>").append(
                $("<input>").attr({
                    "type" : "checkbox"
                    "id"   : line_prefix + "__sel"
                })
                    
            ).bind("change", (event) =>
                @change_d_sel(event)
            )
        ).append(
            get_expand_td(line_prefix, "pdc", undefined, @expand_device)
        ).append(
            $("<td>").attr({
                "colspan" : 8
            }).text("device " + cur_dev.text()
            ).append(
                $("<span>").attr({
                    "id" : line_prefix + "__pinfo"
                }).text("---")
            )
        )
        dummy_div.append(new_tr)
        @xml.find("package_device_connections package_device_connection[device='" + cur_dev.attr("pk") + "']").each (index, pdc_xml) =>
            dummy_div.append(@draw_pdc(cur_dev, $(pdc_xml)))
        @dev_exp_state[cur_dev.attr("key")] = false
        return dummy_div.children()
    expand_device: (line_prefix, state, name) =>
        if state
            (line.show() for line in @get_pdc_lines(@table.find("tr[id='" + line_prefix + "']")))
        else
            (line.hide() for line in @get_pdc_lines(@table.find("tr[id='" + line_prefix + "']")))
        @dev_exp_state[line_prefix] = state
    draw_pdc: (cur_dev, pdc_xml) =>
        line_prefix = pdc_xml.attr("key")
        pack_xml = @pack_xml.find("packages package[pk='" + pdc_xml.attr("package") + "']")
        new_tr = $("<tr>").attr({
            "id"    : line_prefix
        })
        new_tr.append(
            $("<td>").attr("colspan", 2).append(
                $("<input>").attr({
                    "type" : "checkbox"
                    "id"   : pdc_xml.attr("key") + "__sel"
                })
            )
        ).append(
            $("<td>").text(pack_xml.text())
        ).append(
            $("<td>").text(pack_xml.attr("version"))
        ).append(
            $("<td>").text(pack_xml.attr("arch"))
        ).append(
            $("<td>").append(@draw_remove(pdc_xml))
        ).append(
            $("<td>").append(@draw_tstate(pdc_xml))
        ).append(
            $("<td>").append(
                $("<span>").attr("id", pdc_xml.attr("key") + "__installed").text("?")
            )
        ).append(
            $("<td>").append(@draw_pflag(pdc_xml, "force_flag"))
        ).append(
            $("<td>").append(@draw_pflag(pdc_xml, "nodeps_flag"))
        )
        if not @dev_exp_state[cur_dev.attr("key")]
            new_tr.hide()
        return new_tr
    draw_remove: (pdc_xml) =>
        return $("<input>").attr({
            "id"    : pdc_xml.attr("key"),
            "type"  : "button",
            "value" : "remove"}).bind("click", (event) =>
                if confirm("really remove ?")
                    @remove_package_xml(@xml.find("package_device_connection[key='" + $(event.target).attr("id") + "']")))
    draw_tstate: (pdc_xml) =>
        cur_ts = $("<select>").attr({
            "id" : pdc_xml.attr("key") + "__tstate"
        })
        @pack_xml.find("target_states target_state").each (index, cur_s) =>
            value = $(cur_s).attr("pk")
            cur_opt = $("<option>").attr({"value" : cur_opt}).text(value)
            if pdc_xml.attr("target_state") == value
                cur_opt.attr("selected", "selected")
            cur_ts.append(cur_opt)
        cur_ts.bind("change", (event) =>
            cur_el = $(event.target)
            $.ajax
                url   : "{% url 'pack:change_target_state' %}"
                data  : {
                    "pdc_key" : cur_el.attr("id")
                    "value"   : cur_el.val()
                }
                success : (xml) ->
                    parse_xml_response(xml)
        )
        return cur_ts
    draw_pflag: (pdc_xml, flag_name) =>
        cur_ts = $("<input>").attr({
            "type" : "checkbox",
            "id"   : pdc_xml.attr("key") + "__" + flag_name})
        if pdc_xml.attr(flag_name) == "1"
            cur_ts.attr("checked", "checked")
        cur_ts.bind("change", (event) =>
            cur_el = $(event.target)
            $.ajax
                url   : "{% url 'pack:change_package_flag' %}"
                data  : {
                    "pdc_key" : cur_el.attr("id"),
                    "value"   : if cur_el.prop("checked") then "1" else "0"
                }
                success : (xml) ->
                    parse_xml_response(xml)
        )
        return cur_ts

use_devs = ->
    sel_list = (entry.data.key for idx, entry of $("div#sidebar_tree").dynatree("getSelectedNodes"))
    $.ajax
        url     : "{% url 'device:get_group_tree' %}"
        error   : handle_ajax_error
        data    : {
            "sel_list"            : sel_list
            "ignore_meta_devices" : 1
            "extra_t0"            : "package_device_connection"
            "extra_t0_device"     : 1
        }
        success : (xml) ->
            if parse_xml_response(xml)
                new device_table($(xml).find("value[name='response']")).build_table($("div#device"), sel_list)

add_install_handlers = ->
    install_devsel_link(use_devs, true)

$(document).ready(add_install_handlers)

{% endinlinecoffeescript %}

</script>

{% endblock %}
