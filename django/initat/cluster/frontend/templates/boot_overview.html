{% extends "main.html" %}

{% load i18n compress %}

{% block title %}{% trans "Boot" %}{% endblock %}


{% block content %}

<h1 class="center">Boot settings</h1>

<h3 id="options">
</h3>

<div id="boot">
</div>

<input type="button" value="update info" onClick="force_update_info(true);"/>

<script type="text/javascript">

// current device selection (with groups)
CUR_DEVICES = undefined;
// current device selection (only devices)
CUR_PURE_DEVICES = undefined;
// current device XML
DEVICES = undefined;
// flag: pending update info (and for log)
UPDATE_PENDING = 0;
UPDATE_DEVLOG_PENDING = 0;
// option dict
OPTION_DICT = new Array();
// XMLs for kernel, image, partition
XML_DICT = new Array();

function load_device_table() {
    load_devices(CUR_DEVICES);
};

function load_devices(sel_list) {
    $.ajax({
        url     : "{% url device:get_group_tree %}",
        error   : handle_ajax_error,
        data    : {
            "sel_list" : sel_list
        },
        success : function(xml) {
            if (parse_xml_response(xml)) {
                DEVICES = $(xml).find("value[name='response']");
                CUR_PURE_DEVICES = [];
                $(xml).find("device[meta_device='0'][tree_selected='selected']").each(function() {
                    CUR_PURE_DEVICES.push($(this).attr("name"));
                });
                draw_table();
                // redraw options
                redraw_options("h");
                redraw_options("s");
                redraw_options("t");
                redraw_options("b");
                redraw_options("k");
                redraw_options("p");
                redraw_options("i");
                redraw_options("l");
                // call update_device_info after table draw
                update_device_info(true);
            }
        }
    });
};

function draw_table() {
    $("div#boot").children().remove();
    b_table = $("<table>").attr({"id" : "boot"});
    DEVICES.find("device_group").each(function() {
        var cur_dg = $(this);
        var new_tr = $("<tr>").attr({
            "class" : "ui-widget ui-widget-header",
            "btype" : "group"
        });
        new_tr.append($("<th>").attr({
            "colspan" : "8"
        }).text("device group " + cur_dg.attr("name")));
        b_table.append(new_tr);
        cur_dg.find("devices device[tree_selected='selected'][meta_device='0']").each(function() {
            var cur_dev = $(this);
            b_table.append(draw_device(cur_dev));
        });
    });
    $("div#boot").append(b_table);
};

function draw_device(d_el) {
    var dummy_div = $("<div>");
    var line_prefix = d_el.attr("key");
    var new_tr = $("<tr>").attr({
        "class" : "ui-widget ui-widget-header",
        "id"    : line_prefix,
        "btype" : "device"
    });
    new_tr.append($("<th>").attr({
        "colspan" : "1"
    }).text(d_el.text()))
    .append($("<td>").attr({"id" : "recv_str"}).addClass("warn").text("waiting"))
    .append($("<td>").attr({"id" : "req_str"}).addClass("warn").text("waiting"))
    .append($("<td>").attr({"id" : "network"}).addClass("warn").text("waiting"));
    
    dummy_div.append(new_tr);
    return dummy_div.children();
};

function use_devs(dt_div) {
    CUR_DEVICES = _.map(dt_div.dynatree("getSelectedNodes"), function(value) {
        return(value.data.key);
    });
    load_device_table();
};

function force_update_info(call_mother) {
    UPDATE_PENDING = 0;
    update_device_info(call_mother);
};

function update_devlog_info() {
    if (CUR_PURE_DEVICES.length && ! UPDATE_DEVLOG_PENDING) {
        UPDATE_DEVLOG_PENDING = 1;
        var send_data = {
            "sel_list" : CUR_PURE_DEVICES
        };
        $.ajax({
            url     : "{% url boot:get_devlog_info %}",
            error   : handle_ajax_error,
            data    : send_data,
            success : function(xml) {
                if (parse_xml_response(xml)) {
                    UPDATE_DEVLOG_PENDING = 0;
                    var b_table = $("table#boot");
                    $(xml).find("device").each(function() {
                        var cur_dev = $(this);
                        var dev_tr = b_table.find("tr#" + cur_dev.attr("key"));
                        var dev_id = dev_tr.attr("id");
                        if (OPTION_DICT["l"]) {
                            var devlog_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_l']");
                            set_devlog_option(cur_dev, devlog_tr);
                        };
                    });
                };
            }
        });
    };
};

function update_device_info(call_mother) {
    if (CUR_PURE_DEVICES.length && ! UPDATE_PENDING) {
        UPDATE_PENDING = 1;
        var send_data = {
            "sel_list" : CUR_PURE_DEVICES
        };
        for (key in OPTION_DICT) {
            send_data["opt_"+ key] = OPTION_DICT[key];
        };
        send_data["call_mother"] = call_mother ? 1 : 0;
        $.ajax({
            url     : "{% url boot:get_boot_info %}",
            error   : handle_ajax_error,
            data    : send_data,
            success : function(xml) {
                if (parse_xml_response(xml)) {
                    UPDATE_PENDING = 0;
                    var b_table = $("table#boot");
                    $(xml).find("device").each(function() {
                        var cur_dev = $(this);
                        var dev_tr = b_table.find("tr#" + cur_dev.attr("key"));
                        var dev_id = dev_tr.attr("id");
                        if (call_mother) {
                            dev_tr.find("td#recv_str").text("rcv: " + cur_dev.attr("recvstate"));
                            dev_tr.find("td#req_str").text("req: " + cur_dev.attr("reqstate"));
                            var net_state = cur_dev.attr("net_state");
                            var tr_class = {"down" : "error", "unknown" : "error", "ping" : "warn", "up" : "ok"}[net_state];
                            dev_tr.find("td#network").text(cur_dev.attr("network") + " ("+ net_state + ")");
                            dev_tr.find("td#recv_str, td#req_str, td#network").removeClass("ok error warn").addClass(tr_class);
                        };
                        if (OPTION_DICT["k"]) {
                            var kernel_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_k']");
                            set_kernel_option(cur_dev, kernel_tr);
                        };
                        if (OPTION_DICT["t"]) {
                            var target_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_t']");
                            set_target_option(cur_dev, target_tr);
                        };
                        if (OPTION_DICT["s"]) {
                            var target_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_s']");
                            set_soft_control_option(cur_dev, target_tr);
                        };
                        if (OPTION_DICT["h"]) {
                            var target_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_h']");
                            set_hard_control_option(cur_dev, target_tr);
                        };
                        if (OPTION_DICT["b"]) {
                            var boot_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_b']");
                            set_boot_option(cur_dev, boot_tr);
                        };
                        if (OPTION_DICT["p"]) {
                            var part_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_p']");
                            set_part_option(cur_dev, part_tr);
                        };
                        if (OPTION_DICT["i"]) {
                            var img_tr = b_table.find("tr[id='" + dev_id + "'][btype='opt_i']");
                            set_img_option(cur_dev, img_tr);
                        };
                    });
                } else {
                    UPDATE_PENDING = 0;
                };
            }
        });
    };
};

function set_boot_option(dev_xml, boot_tr) {
    var dev_id = boot_tr.attr("id");
    var boot_dev_name = boot_tr.find("span#" + dev_id + "__boot_dev_name");
    var boot_dev_macaddr = boot_tr.find("input#" + dev_id + "__boot_dev_macaddr");
    var boot_dev_driver = boot_tr.find("input#" + dev_id + "__boot_dev_driver");
    var boot_dev_greedy_mode = boot_tr.find("input#" + dev_id + "__greedy_mode");
    var boot_dev_dhcp = boot_tr.find("input#" + dev_id + "__write_dhcp");
    if (boot_tr.find(":disabled").length) {
        boot_dev_macaddr.val(dev_xml.attr("boot_dev_macaddr"));
        boot_dev_driver.val(dev_xml.attr("boot_dev_driver"));
        if (dev_xml.attr("greedy_mode") == 1) {
            boot_dev_greedy_mode.attr({"checked" : "checked"});
        } else {
            boot_dev_greedy_mode.removeAttr("checked");
        };
        if (dev_xml.attr("dhcp_write") == 1) {
            boot_dev_dhcp.attr({"checked" : "checked"});
        } else {
            boot_dev_dhcp.removeAttr("checked");
        };
        boot_dev_macaddr.removeAttr("disabled");
        boot_dev_driver.removeAttr("disabled");
        boot_dev_greedy_mode.removeAttr("disabled");
        boot_dev_dhcp.removeAttr("disabled");
        boot_dev_macaddr.bind("change", change_boot);
        boot_dev_driver.bind("change", change_boot);
        boot_dev_greedy_mode.bind("change", change_boot);
        boot_dev_dhcp.bind("change", change_boot);
    } else {
        if (dev_xml.attr("boot_dev_macaddr") != boot_dev_macaddr.val()) {
            $.jnotify("MAC address changed to " + dev_xml.attr("boot_dev_macaddr"));
            boot_dev_macaddr.val(dev_xml.attr("boot_dev_macaddr"));
        };
        if (dev_xml.attr("greedy_mode") == 0 && boot_dev_greedy_mode.is(":checked")) {
            boot_dev_greedy_mode.removeAttr("checked");
        } else if (dev_xml.attr("greedy_mode") == 1 && ! boot_dev_greedy_mode.is(":checked")) {
            boot_dev_greedy_mode.attr("checked", "checked");
        };
    };
    boot_dev_name.text(dev_xml.attr("boot_dev_name"));
};

function set_soft_control_option(dev_xml, scon_tr) {
    // nothing to do
};

function set_hard_control_option(dev_xml, hcon_tr) {
    var dev_id = hcon_tr.attr("id");
    var new_hcon = hcon_tr.find("span#" + dev_id + "__hard_control");
    if (new_hcon.attr("disabled") == "disabled") {
        if (dev_xml.find("cd_connection").length) {
            new_hcon.text("");
            dev_xml.find("cd_connection").each(function() {
                var new_cd = $(this);
                new_hcon.append(new_cd.attr("parent_name") + " : ");
                var new_el = $("<select>").attr({
                    "id" : dev_id + "__" + new_cd.attr("key")
                }).bind("change", change_hard_control);
                new_el.append($("<option>").attr(
                    {"value" : "0"}).text("---"));
                $.each(["on", "off", "cycle"], function(key, value) {
                    var hd_opt = $("<option>").attr({
                        "value" : value}).text(value);
                    new_el.append(hd_opt);
                });
                new_hcon.append(new_el);    
            });
            new_hcon.removeAttr("disabled");
        } else {
            new_hcon.text("nothing found");
        };
    };
};

function change_hard_control(event) {
    var cur_el = $(event.target);
    $.ajax({
        url     : "{% url boot:hard_control %}",
        error   : handle_ajax_error,
        data    : {
            "cd_id" : cur_el.attr("id"),
            "value" : cur_el.val()
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
            }
        }
    });
    cur_el.val("0");
};

function set_part_option(dev_xml, part_tr) {
    var dev_id = part_tr.attr("id");
    var new_part = part_tr.find("select#" + dev_id + "__new_part");
    if (part_tr.find(":disabled").length) {
        new_part.val(dev_xml.attr("partition_table_id"));
        new_part.removeAttr("disabled");
        new_part.bind("change", change_part);
    } else {
    };
};

function set_devlog_option(dev_xml, devlog_tr) {
    var dev_id = devlog_tr.attr("id");
    var log_sel = devlog_tr.find("select#" + dev_id + "__device_log");
    if (devlog_tr.find(":disabled").length) {
        log_sel.removeAttr("disabled");
        log_sel.attr("multiple", "6");
    };
    log_sel.children().remove();
    dev_xml.find("devicelogs devicelog").each(function() {
        var cur_log = $(this);
        var new_opt = $("<option>").text(cur_log.attr("date") + " :: " + cur_log.attr("text"));
        log_sel.prepend(new_opt);
    });
};

function set_img_option(dev_xml, img_tr) {
    var dev_id = img_tr.attr("id");
    var new_img = img_tr.find("select#" + dev_id + "__new_image");
    if (img_tr.find(":disabled").length) {
        new_img.val(dev_xml.attr("new_image"));
        new_img.removeAttr("disabled");
        new_img.bind("change", change_image);
    } else {
    };
};

function change_image(boot) {
    var el = $(event.target);
    var img_tr = el.parents("tr:first");
    var dev_id = img_tr.attr("id");
    $.ajax({
        url     : "{% url boot:set_image %}",
        data    : {
            "dev_id"    : dev_id,
            "new_image" : img_tr.find("select#" + dev_id + "__new_image").val()
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
            }
        }
    });
};

function change_part(boot) {
    var el = $(event.target);
    var part_tr = el.parents("tr:first");
    var dev_id = part_tr.attr("id");
    $.ajax({
        url     : "{% url boot:set_partition %}",
        data    : {
            "dev_id"   : dev_id,
            "new_part" : part_tr.find("select#" + dev_id + "__new_part").val()
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
            }
        }
    });
};

function change_boot(event) {
    var el = $(event.target);
    var boot_tr = el.parents("tr:first");
    var dev_id = boot_tr.attr("id");
    $.ajax({
        url     : "{% url boot:set_boot %}",
        data    : {
            "dev_id"      : dev_id,
            "boot_mac"    : boot_tr.find("input#" + dev_id + "__boot_dev_macaddr").val(),
            "boot_driver" : boot_tr.find("input#" + dev_id + "__boot_dev_driver").val(),
            "greedy_mode" : boot_tr.find("input#" + dev_id + "__greedy_mode:checked").length ? "1" : "0",
            "dhcp_write"  : boot_tr.find("input#" + dev_id + "__write_dhcp:checked").length ? "1" : "0"
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
            }
        }
    });
};

function set_target_option(dev_xml, target_tr) {
    var dev_id = target_tr.attr("id");
    if (target_tr.find(":disabled").length) {
        var target_state = target_tr.find("select#" + dev_id + "__target_state");
        target_state.val(dev_xml.attr("full_new_state"));
        target_state.removeAttr("disabled");
        target_state.bind("change", change_target_state);
    };
};


function change_target_state(event) {
    var el = $(event.target);
    var target_tr = el.parents("tr:first");
    var dev_id = target_tr.attr("id");
    $.ajax({
        url     : "{% url boot:set_target_state %}",
        data    : {
            "dev_id"    : dev_id,
            "new_state" : target_tr.find("select#" + dev_id + "__target_state").val()
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
            }
        }
    });
};

function set_kernel_option(dev_xml, kernel_tr) {
    var dev_id = kernel_tr.attr("id");
    // copy info from kernel_tr to table
    if (kernel_tr.find(":disabled").length) {
        var new_kernel = kernel_tr.find("select#" + dev_id + "__new_kernel");
        var act_kernel = kernel_tr.find("span#" + dev_id + "__act_kernel");
        var stage1_flav = kernel_tr.find("select#" + dev_id + "__kernel_flavour");
        var kernel_append = kernel_tr.find("input#" + dev_id + "__kernel_append");
        new_kernel.val(dev_xml.attr("new_kernel"));
        kernel_append.val(dev_xml.attr("new_append"));
        stage1_flav.val(dev_xml.attr("stage1_flavour"));
        new_kernel.removeAttr("disabled");
        stage1_flav.removeAttr("disabled");
        kernel_append.removeAttr("disabled");
        new_kernel.bind("change", change_kernel);
        stage1_flav.bind("change", change_kernel);
        kernel_append.bind("change", change_kernel);
    };
};

function change_kernel(event) {
    var el = $(event.target);
    var kernel_tr = el.parents("tr:first");
    var dev_id = kernel_tr.attr("id");
    $.ajax({
        url     : "{% url boot:set_kernel %}",
        data    : {
            "dev_id"         : dev_id,
            "new_kernel"     : kernel_tr.find("select#" + dev_id + "__new_kernel").val(),
            "kernel_flavour" : kernel_tr.find("select#" + dev_id + "__kernel_flavour").val(),
            "kernel_append"  : kernel_tr.find("input#" + dev_id + "__kernel_append").val()
        },
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
            }
        }
    });
};

function change_option(event) {
    var el = $(event.target);
    var opt = el.attr("id").split("_")[1];
    var checked = el.is(":checked");
    OPTION_DICT[opt] = checked;
    if (checked) {
        $.ajax({
            url     : "{% url boot:get_addon_info %}",
            data    : {
                "type" : opt
            },
            error   : handle_ajax_error,
            success : function(xml) {
                if (parse_xml_response(xml)) {
                    XML_DICT[opt] = xml;
                    redraw_options(opt);
                }
            }
        });
    } else {
        redraw_options(opt);
    };
};

// create option lines
function redraw_options(opt) {
    if (OPTION_DICT[opt]) {
        var get_info_from_server = true;
        var get_devlog_info_from_server = false;
        // add lines
        $("table#boot").find("tr[btype='device']").each(function() {
            var dev_tr = $(this);
            var dev_id = dev_tr.attr("id");
            var new_tr = $("<tr>").attr({
                "btype" : "opt_" + opt,
                "id"    : dev_id
            });
            dev_tr.after(new_tr);
            first_td = $("<td>");
            new_tr.append(first_td);
            switch (opt) {
                case "k":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("kernel:");
                    var kernel_sel = $("<select>").attr({
                        "disabled" : "disabled",
                        "id"       : dev_id + "__new_kernel"
                    });
                    kernel_sel.append($("<option>").attr({"value" : "0"}).text("not set"));
                    $(XML_DICT["k"]).find("kernel").each(function() {
                        var cur_kernel = $(this);
                        kernel_sel.append($("<option>").attr({"value" : cur_kernel.attr("pk")}).text(cur_kernel.attr("name")));
                    });
                    first_td.append(kernel_sel);
                    first_td.append(", actual kernel: ").append($("<span>").attr({
                        "id" : dev_id + "__act_kernel"
                    }));
                    first_td.append(", stage 1 flavour : ");
                    var stage1_flav = $("<select>").attr({
                        "disabled" : "disabled",
                        "id"       : dev_id + "__kernel_flavour"
                    });
                    stage1_flav.append($("<option>").attr({"value" : "none"}).text("not set"));
                    stage1_flav.append($("<option>").attr({"value" : "cpio"}).text("CPIO"));
                    stage1_flav.append($("<option>").attr({"value" : "cramfs"}).text("CramFS"));
                    stage1_flav.append($("<option>").attr({"value" : "lo"}).text("ext2 via Loopback"));
                    first_td.append(stage1_flav);
                    first_td.append(", kernel append:");
                    first_td.append($("<input>").attr({
                        "type"     : "text",
                        "id"       : dev_id + "__kernel_append",
                        "disabled" : "disabled"}));
                    break;
                case "h":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("hard control:");
                    var hard_con = $("<span>").attr({
                        "id"       : dev_id + "__hard_control",
                        "disabled" : "disabled"
                    }).text("waiting");
                    first_td.append(hard_con);
                    break;
                case "s":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("soft control:");
                    $.each(["status", "reboot", "halt", "poweroff"], function(key, value) {
                        var radio_el = $("<input>").attr({
                            "type"    : "radio",
                            "name"    : dev_id + "__soft_control",
                            "id"      : dev_id + "__" + value,
                            "value"   : value}).bind("click", soft_control);
                        if (key == 0) radio_el.attr("checked", "checked");
                        first_td.append(radio_el).append($("<span>").text(value));
                    });
                    get_info_from_server = false;
                    break;
                case "t":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("target state:");
                    var target_sel = $("<select>").attr({
                        "disabled" : "disabled",
                        "id"       : dev_id + "__target_state"
                    });
                    target_sel.append($("<option>").attr({"value" : "0__0"}).text("not set"));
                    $(XML_DICT["t"]).find("status").each(function() {
                        var cur_tstate = $(this);
                        target_sel.append($("<option>").attr({"value" : cur_tstate.attr("pk") + "__" + cur_tstate.attr("prod_net")}).text(cur_tstate.text()));
                    });
                    first_td.append(target_sel);
                    break;
                case "b":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("MAC Address of bootdevice ");
                    first_td.append($("<span>").attr({
                        "id" : dev_id + "__boot_dev_name"}).text("---"));
                    first_td.append(":");
                    first_td.append($("<input>").attr({
                        "id"       : dev_id + "__boot_dev_macaddr",
                        "type"     : "text",
                        "disabled" : "disabled"}));
                    first_td.append(", DHCP: ");
                    first_td.append($("<input>").attr({
                        "id"       : dev_id + "__write_dhcp",
                        "type"     : "checkbox",
                        "disabled" : "disabled"}));
                    first_td.append(", driver: ");
                    first_td.append($("<input>").attr({
                        "id"       : dev_id + "__boot_dev_driver",
                        "type"     : "text",
                        "disabled" : "disabled"}));
                    first_td.append(", greedy mode: ");
                    first_td.append($("<input>").attr({
                        "id"       : dev_id + "__greedy_mode",
                        "type"     : "checkbox",
                        "disabled" : "disabled"}));
                    break;
                case "p":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("Partition ");
                    var part_sel = $("<select>").attr({
                        "disabled" : "disabled",
                        "id"       : dev_id + "__new_part"
                    });
                    part_sel.append($("<option>").attr({"value" : "0__0"}).text("not set"));
                    $(XML_DICT["p"]).find("partition_table").each(function() {
                        var cur_part = $(this);
                        var part_opt = $("<option>").attr({"value" : cur_part.attr("pk")}).text(cur_part.attr("name"));
                        if (cur_part.attr("valid") == 0) part_opt.attr("disabled", "disabled");
                        part_sel.append(part_opt);
                    });
                    first_td.append(part_sel);
                    break;
                case "i":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("Image ");
                    var img_sel = $("<select>").attr({
                        "disabled" : "disabled",
                        "id"       : dev_id + "__new_image"
                    });
                    img_sel.append($("<option>").attr({"value" : "0__0"}).text("not set"));
                    $(XML_DICT["i"]).find("image").each(function() {
                        var cur_img = $(this);
                        var img_opt = $("<option>").attr({"value" : cur_img.attr("pk")}).text(cur_img.attr("name"));
                        if (cur_img.attr("valid") == 0) part_opt.attr("disabled", "disabled");
                        img_sel.append(img_opt);
                    });
                    first_td.append(img_sel);
                    break;
                case "l":
                    first_td.attr({"colspan" : "5"});
                    first_td.append("Device log ");
                    var dev_sel = $("<select>").attr({
                        "id"       : dev_id + "__device_log",
                        "disabled" : "disabled"
                    });
                    first_td.append(dev_sel);
                    get_info_from_server = false;
                    get_devlog_info_from_server = true;
                    break;
            };
        });
        if (get_info_from_server) force_update_info(false);
        if (get_devlog_info_from_server) update_devlog_info(false);
    } else {
        // remove lines
        $("table#boot").find("tr[btype='opt_" + opt + "']").remove();
    };
};

function soft_control(event) {
    var cur_el = $(event.target);
    if (cur_el.val() != "status") {
        $.ajax({
            url     : "{% url boot:soft_control %}",
            error   : handle_ajax_error,
            data    : {
                "key" : cur_el.attr("id")
            },
            success : function(xml) {
                if (parse_xml_response(xml)) {
                    cur_el.removeAttr("checked");
                    $("input[type='radio'][id='dev__" + cur_el.attr("id").split("__")[1] + "__status']").attr("checked", "checked");
                };
            }
        });
    };
};

function install_options() {
    $.ajax({
        url     : "{% url boot:get_html_options %}",
        error   : handle_ajax_error,
        success : function(xml) {
            if (parse_xml_response(xml)) {
                var opt_h3 = $("h3#options");
                $(xml).find("option").each(function() {
                    var opt = $(this);
                    var opt_button = $("<input>").attr({
                        "type" : "checkbox",
                        "id"   : "opt_" + opt.attr("short")})
                    opt_h3.append(opt_button);
                    opt_h3.append($("<label>").attr({"for" : "opt_" + opt.attr("short")}).text(opt.text()));
                    opt_button.bind("change", change_option);
                });
                opt_h3.find("input").button();
                opt_h3.buttonset();
            }
        }
    });
};
    

function add_config_handlers() {
    install_options();
    install_devsel_link(use_devs, true);
    $(document).everyTime(10000, "update_device_info", function(i) {
        update_device_info(true);
    });
    $(document).everyTime(10000, "update_devlog_info", function(i) {
        update_devlog_info(true);
    });
};

$(document).ready(add_config_handlers);

</script>

{% endblock %}
