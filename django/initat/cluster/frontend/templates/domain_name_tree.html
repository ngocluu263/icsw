{% extends "main.html" %}

{% load i18n extra_tags coffeescript %}

{% block title %}Domain name tree{% endblock %}

{% block content %}

<h1>Domain name tree</h1>

<div id="dnt_div"></div>
<div id="dnt_detail"></div>

<script type="text/javascript">

{% inlinecoffeescript %}

class domain_name_tree
    constructor: (@top_div) ->
        @load_dnt()
    load_dnt: () =>
        $.ajax
            url     : "{% url 'network:domain_name_tree' %}"
            success : (xml) =>
                if parse_xml_response(xml)
                    @DNT = $(xml).find("domain_tree_nodes")
                    @my_submitter = new submitter({
                        master_xml       : @DNT,
                        success_callback : @change_cb
                    })
                    @build_tree()
    build_tree: () =>
        @top_div.dynatree
            autoFocus  : false
            debuglevel : {% if DEBUG %}0{% else %}0{% endif %}
            onExpand : (flag, dtnode) =>
            onSelect : (flag, dtnode) =>
            onFocus  : (dtnode) =>
                @show_details(dtnode.data.key)
                return false
            dndxx : {
                onDragStart : (dtnode) =>
                    #console.log dtnode.data.title
                    return true
                onDragEnter : (dest_node, src_node) =>
                    if parseInt(@DNT.find("domain_tree_node[pk='#{src_node.data.key}']").attr("parent")) == 0
                        return false
                    else
                        return true
                onDrop: (dest_node, src_node, hit_mode, ui, draggable) =>
                    #console.log src_node, dest_node, hit_mode
                    #src_node.move(dest_node, hit_mode)
            }
        @root_node = @top_div.dynatree("getRoot")
        @build_node(@root_node, @DNT.find("domain_tree_node[parent='0']"))
    build_node: (dt_node, db_node) =>
        if parseInt(db_node.attr("parent")) == 0
            title_str = "TOP"
            expand_flag = true
        else
            title_str = db_node.attr("name") + " (*." + db_node.attr("full_name") + ")"
            expand_flag = false
        new_node = dt_node.addChild(
            title    : title_str
            isFolder : true
            expand   : expand_flag
            key      : db_node.attr("pk")
        )
        @DNT.find("domain_tree_node[parent='" + db_node.attr("pk") + "']").each (idx, sub_db_node) =>
            @build_node(new_node, $(sub_db_node))
    show_details: (key) =>
        cur_node = @DNT.find("domain_tree_node[pk='#{key}']")
        $("div#dnt_detail").children().remove()
        if parseInt(cur_node.attr("parent"))
            line_prefix = "dtn__#{cur_node.attr('pk')}"
            new_ul = $("<ul>")
            new_ul.append(
                $("<li>").append(
                    create_input_el(cur_node, "name", line_prefix, {
                        master_xml : @DNT,
                        label : "Name : "
                        submitter : @my_submitter,
                    })
                )
            )
            new_ul.append(
                $("<li>").append(
                    create_input_el(cur_node, "intermediate", line_prefix, {
                        boolean : true,
                        ro : true,
                        label : "Intermediate : ",
                    })
                )
            )
            new_ul.append(
                $("<li>").append(
                    create_input_el(cur_node, "create_short_names", line_prefix, {
                        boolean : true,
                        label : "Create short names : ",
                    })
                )
            )
            new_ul.append(
                $("<li>").append(
                    create_input_el(cur_node, "always_create_ip", line_prefix, {
                        boolean : true,
                        label : "Always create IP : ",
                    })
                )
            )
            new_ul.append(
                $("<li>").append(
                    create_input_el(cur_node, "write_namserver_config", line_prefix, {
                        boolean : true,
                        label : "Create nameserver config : ",
                    })
                )
            )
            $("div#dnt_detail").append(new_ul)
    rename_tree: (cur_node) =>
        cur_db_node = @DNT.find("domain_tree_node[pk='#{cur_node.data.key}']")
        parent_db_node = @DNT.find("domain_tree_node[pk='" + cur_db_node.attr("parent") + "']")
        cur_db_node.attr("full_name", (if parent_db_node.attr("full_name") then parent_db_node.attr("full_name") + "." else "") + cur_db_node.attr("name"))
        cur_node.data.title = cur_db_node.attr("name") + " (*." + cur_db_node.attr("full_name") + ")"
        cur_node.render()
        if cur_node.hasChildren()
            for sub_node in cur_node.getChildren()
                @rename_tree(sub_node)
    change_cb: (cur_el) =>
        c_type = cur_el.attr("id").split("__")[2]
        node_key = cur_el.attr("id").split("__")[1]
        if c_type == "name"
            dt_node = @top_div.dynatree("getTree").getNodeByKey(node_key)
            @rename_tree(dt_node, cur_el.val())

$(document).ready(
    my_dnt = new domain_name_tree($("div#dnt_div"))
)

{% endinlinecoffeescript %}

</script>

{% endblock %}
