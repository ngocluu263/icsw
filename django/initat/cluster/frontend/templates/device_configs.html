{% extends "main.html" %}

{% load i18n compress coffeescript %}

{% block title %}{% trans "Device Configuration" %}{% endblock %}

{% block content %}

<h1 class="center">Device configuration, <span id="config_info">none defined</span>, filter:
<input type="text" id="filter" value=""/>, only selected:
<input type="checkbox" id="filter_assoc"/>,
<input type="button" id="filter_clear" value="clear"/></h1>

<div id="config"></div>

{% include "generate_config.html" %}

<script type="text/javascript">

{% inlinecoffeescript %}

class config_table
    constructor: (@top_div) ->
        @cur_filter = ""
        @show_list = ""
        @only_associated = false
        $("input#filter").bind("keyup", => @apply_filter(false))
        $("input#filter_clear").bind("click", @clear_filter)
        $("input#filter_assoc").bind("click", @change_assoc_filter)
    use_devs: (dt_div) =>
        sel_list = (value.data.key for value in dt_div.dynatree("getSelectedNodes"))
        notify_generate_link(sel_list)
        $.ajax
            url     : "{% url 'device:get_group_tree' %}"
            data    : {
                "sel_list"  : sel_list
                "full_name" : 1
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @devices = $(xml).find("value[name='response']")
                    @load_device_configs(sel_list)
    load_device_configs : (sel_list) =>
        $.ajax
            url     : "{% url 'config:get_device_configs' %}"
            data    : {
                "sel_list" : sel_list
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @device_configs = $(xml).find("value[name='response']")
                    @load_configs()
    load_configs : () =>
        $.ajax
            url     : "{% url 'config:show_configs' %}"
            data    : {
                #"mode" : "simple"
                "mode" : "full"
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @configs = $(xml).find("value[name='response']")
                    @apply_filter(true)
    change_assoc_filter: (event) =>
        cur_el = $(event.target)
        @only_associated = cur_el.is(":checked")
        @apply_filter(true)
    apply_filter : (force_reload) =>
        cur_text = $("input#filter").attr("value")
        if (cur_text != @cur_filter) or force_reload
            @cur_filter = cur_text
            cur_re = new RegExp("^.*#{@cur_filter}.*$")
            disp_list = new Array()
            # get keys/pks for current filter
            @configs.find("config").each (idx, c_config) =>
                c_config = $(c_config)
                if c_config.attr("name").match(cur_re)
                    if @only_associated
                        conf_pk = c_config.attr("pk")
                        if @device_configs.find("device_config[config='#{conf_pk}']").length
                            disp_list.push(c_config.attr("key"))
                    else
                        disp_list.push(c_config.attr("key"))
            # not working, FIXME
            if (@show_list != disp_list) or force_reload
                @display_list = (@configs.find("config[key='#{name}']")[0] for name in disp_list)
                @update_config_info(disp_list.length)
                cur_exp_list = @get_expand_list()
                @draw_tables()
                @restore_expansion(cur_exp_list)
            @show_list = disp_list
    get_expand_list : =>
        if @c_table
            ret_list = ($(cur_el).attr("id") for cur_el in @c_table.find("tr div[id*='__expand__'][class*='-1-s']"))
        else
            ret_list = []
        return ret_list
    update_config_info : (num_shown) =>
        info_str = "configs defined: " + @configs.find("config").length
        if num_shown == @configs.find("config").length
            info_str += ", all shown"
        else
            info_str += ", #{num_shown} shown"
        $("span#config_info").text(info_str)
    clear_filter : =>
        $("input#filter").val("")
        $("input#filter_assoc").removeAttr("checked")
        @only_associated = false
        @apply_filter(false)
    draw_tables : =>
        @selected = {}
        @meta_selected = {}
        @top_div.children().remove()
        c_table = $("<table>").attr({"id" : "config"}).addClass("devicelist")
        @devices.find("device_group").each (idx, cur_dg) =>
            cur_dg = $(cur_dg)
            new_tr = $("<tr>").attr({
                "class"   : "ui-widget ui-widget-header devicegroup"
            })
            new_tr.append($("<th>").css({
                "padding" : "5px",
                "border"  : "1px solid black"
            }).attr({
                "colspan" : "9"
            }).text("device group " + cur_dg.attr("name")))
            c_table.append(new_tr)
            # at first append metadevice
            cur_dg.find("devices device[selected='selected'][meta_device='1']").each (meta_idx, meta_dev) =>
                c_table.append(@draw_device($(meta_dev)))
            cur_dg.find("devices device[selected='selected'][meta_device='0']").each (dev_idx, cur_dev) =>
                c_table.append(@draw_device($(cur_dev)))
        @top_div.append(c_table)
        @c_table = c_table
    draw_device : (d_el) =>
        dev_pk = d_el.attr("pk")
        dummy_div = $("<div>")
        line_prefix = d_el.attr("key")
        new_tr = $("<tr>").attr({
            "class" : "ui-widget ui-widget-header",
            "id"    : line_prefix
        })
        new_tr.append(get_expand_td(line_prefix, "config", "config", @toggle_config_line))
        new_tr.append($("<th>").attr({
            "class"   : "left",
            "colspan" : "8",
            "id"      : dev_pk,
        }))
        dummy_div.append(new_tr)
        cur_entries = 0
        run_idx = 1
        @selected[dev_pk] = []
        @meta_selected[dev_pk] = []
        for cur_conf in @display_list
            cur_conf = $(cur_conf)
            conf_pk = cur_conf.attr("pk")
            if !cur_entries
                cur_tr = $("<tr>").attr({
                    "id" : "#{line_prefix}__config__#{run_idx}"
                }).hide()
                cur_tr.append($("<td>"))
            cur_cb = $("<input>").attr({
                "type" : "checkbox",
                "id"   : "#{line_prefix}__config__#{conf_pk}"
            }).bind("click", @change_config)

            cur_tr.append(
                $("<td>").attr({
                   "class" : "center"
                }).on("hover", @hover).append(
                    $("<span>")
                ).append(
                    cur_cb
                ).append(
                    $("<span>")
                )
            )
            if @device_configs.find("device_config[device='#{dev_pk}'][config='#{conf_pk}'][meta='1']").length
                cur_cb.attr({"checked" : "checked"})
                cur_cb.prev().text("(")
                cur_cb.next().text(")")
                @meta_selected[dev_pk].push(conf_pk)
            else if @device_configs.find("device_config[device='#{dev_pk}'][config='#{conf_pk}']").length
                cur_cb.attr({"checked" : "checked"})
                @selected[dev_pk].push(conf_pk)
            num_vars    = cur_conf.find("config_vars *").length
            num_scripts = cur_conf.find("config_scripts *").length
            num_checks  = cur_conf.find("mon_check_commands *").length
            cur_tr.append($("<td>").on("hover", @hover).append(
                $("<span>").attr("title", "#{num_vars} variables, #{num_scripts} scripts, #{num_checks} check commands").text(cur_conf.attr("name") + " (#{num_vars}, #{num_scripts}, #{num_checks})")
            ))
            cur_entries++
            if cur_entries == 4
                dummy_div.append(cur_tr)
                cur_entries = 0
                run_idx += 1
        @update_device_info(dev_pk, new_tr.find("th"))
        if cur_entries
            # add dummy entries for colorization
            cur_tr.append($("<td>").attr("colspan", 2 * (4 - cur_entries)))
            dummy_div.append(cur_tr)
        # beautify it
        dummy_div.find("tr:even").addClass("even")
        dummy_div.find("tr:odd").addClass("odd")
        return dummy_div.children()
    hover: (event) ->
        target = $(event.target)
        if target.prop("tagName") != "TD"
            target = target.parents("td:first")
        # a little hackish but working
        if not target.hasClass("center")
            target = target.prev()
        if event.type == "mouseenter"
            target.addClass("highlight")
            target.next().addClass("highlight")
        else
            target.removeClass("highlight")
            target.next().removeClass("highlight")
    restore_expansion : (exp_list) =>
        for cur_val in exp_list
            @toggle_config_line(cur_val.split("__")[0] + "__" + cur_val.split("__")[1], true, "config")
    toggle_config_line : (line_prefix, state, line_spec) =>
        conf_line = @c_table.find("tr[id='#{line_prefix}']")
        exp_line  = @c_table.find("tr[id^='#{line_prefix}__#{line_spec}']")
        if state
            exp_line.show()
            force_expansion_state(conf_line, true)
        else
            exp_line.hide()
            force_expansion_state(conf_line, false)
    update_device_info: (dev_pk, dev_th) =>
        selected = @selected[dev_pk].length
        meta_selected = @meta_selected[dev_pk].length
        cur_dev = @devices.find("device[pk='#{dev_pk}']")
        is_meta = cur_dev.attr("meta_device") == "1"
        dev_str = (if is_meta then "Meta device" else "device") + " " + cur_dev.attr("full_name")
        if cur_dev.attr("comment")
            dev_str = "#{dev_str} (" + cur_dev.attr("comment") + ")"
        if selected
            dev_str = "#{dev_str}, #{selected} selected"
        if meta_selected
            dev_str = "#{dev_str}, #{meta_selected} via meta"
        if dev_th
            dev_th.text(dev_str)
        else
            @c_table.find("tr th[id='#{dev_pk}']").text(dev_str)
    change_config : (event) =>
        cur_cb = $(event.target)
        lock_list = lock_elements(@c_table)
        $.ajax
            url  : "{% url 'config:alter_config_cb' %}"
            data : {
                "id"    : cur_cb.attr("id")
                "value" : if cur_cb.is(":checked") then "1" else "0"
            },
            success : (xml) =>
                parse_xml_response(xml)
                res_xml = $(xml)
                conf_pk = res_xml.find("device_configs config").attr("pk")
                # remove selection
                for dev_pk of @selected
                    @selected[dev_pk]      = @selected[dev_pk].filter (val) -> val != conf_pk
                    @meta_selected[dev_pk] = @meta_selected[dev_pk].filter (val) -> val != conf_pk
                res_xml.find("devices device").each (xml_idx, cur_dev) =>
                    # deselect all checkboxes
                    cur_dev = $(cur_dev)
                    dev_pk = cur_dev.attr("pk")
                    cur_cb = @c_table.find("input[id='dev__#{dev_pk}__config__#{conf_pk}']")
                    cur_cb.removeAttr("checked")
                    cur_cb.prev().text("")
                    cur_cb.next().text("")
                res_xml.find("device_configs device_config").each (xml_idx, cur_dc) =>
                    cur_dc = $(cur_dc)
                    dev_pk = cur_dc.attr("device")
                    if dev_pk of @selected
                        cur_cb = @c_table.find("input[id='dev__#{dev_pk}__config__#{conf_pk}']")
                        cur_cb.attr("checked", "checked")
                        if cur_dc.attr("meta") == "1"
                            cur_cb.prev().text("(")
                            cur_cb.next().text(")")
                            @meta_selected[dev_pk].push(conf_pk)
                        else
                            @selected[dev_pk].push(conf_pk)
                for dev_pk, sel_list of @selected
                    @update_device_info(dev_pk)
                unlock_elements(lock_list)

add_dcon_handlers = ->
    conf_t = new config_table($("div#config"))
    install_devsel_link(conf_t.use_devs, true)

$(document).ready(add_dcon_handlers)

{% endinlinecoffeescript %}

</script>

{% endblock %}
