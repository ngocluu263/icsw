{% extends "main.html" %}

{% load i18n compress coffeescript %}

{% block title %}{% trans "Device Configuration" %}{% endblock %}

{% block content %}

<h1 class="center">Device configuration, <span id="config_info">none defined</span>, filter:
<input type="text" id="filter" value=""/>
<input type="button" id="filter_clear" value="clear"/></h1>

<div id="config"></div>

{% include "generate_monitoring_config.html" %}

{% include "generate_config.html" %}

<script type="text/javascript">

{% inlinecoffeescript %}

class config_table
    constructor: (@top_div) ->
        @cur_filter = ""
        @show_list = ""
    use_devs: (dt_div) =>
        sel_list = (value.data.key for value in dt_div.dynatree("getSelectedNodes"))
        notify_generate_link(sel_list)
        $.ajax
            url     : "{% url device:get_group_tree %}"
            error   : handle_ajax_error
            data    : {
                "sel_list" : sel_list
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @devices = $(xml).find("value[name='response']")
                    @load_device_configs(sel_list)
    load_device_configs : (sel_list) =>
        $.ajax
            url     : "{% url config:get_device_configs %}"
            error   : handle_ajax_error
            data    : {
                "sel_list" : sel_list
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @device_configs = $(xml).find("value[name='response']")
                    @load_configs()
    load_configs : () =>
        $.ajax
            url     : "{% url config:get_configs %}"
            error   : handle_ajax_error
            data    : {
                "mode" : "simple"
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @configs = $(xml).find("value[name='response']")
                    @apply_filter(true)
    apply_filter : (force_reload) =>
        cur_text = $("input#filter").attr("value")
        if (cur_text != @cur_filter) or force_reload
            @cur_filter = cur_text
            cur_re = new RegExp("^.*" + @cur_filter+ ".*$")
            console.log cur_re
            disp_list = new Array()
            # get keys/pks for current filter
            @configs.find("config").each (idx, c_config) =>
                c_config = $(c_config)
                if c_config.attr("name").match(cur_re)
                    disp_list.push(c_config.attr("key"))
            console.log disp_list
            # not working, FIXME
            if (@show_list != disp_list) or force_reload
                @display_list = (@configs.find("config[key='" + name + "']")[0] for name in disp_list)
                console.log @display_list
                @update_config_info(disp_list.length);
                cur_exp_list = @get_expand_list()
                @draw_tables()
                @restore_expansion(cur_exp_list)
            @show_list = disp_list
    get_expand_list : =>
        ret_list = ($(cur_el).attr("id") for cur_el in @c_table.find("tr span[id*='__expand__'][class*='-1-s']"))
        console.log "rl", ret_list
        return ret_list
    update_config_info : (num_shown) =>
        info_str = "configs defined: " + @configs.find("config").length
        if num_shown == @configs.find("config").length
            info_str += ", all shown"
        else
            info_str += ", " + num_shown + " shown"
        $("span#config_info").text(info_str)
    clear_filter : =>
        $("input#filter").val("")
        @apply_filter(false)
    draw_tables : =>
        @top_div.children().remove();
        c_table = $("<table>").attr({"id" : "config"})
        @devices.find("device_group").each (idx, cur_dg) =>
            cur_dg = $(cur_dg)
            new_tr = $("<tr>").attr({
                "class"   : "ui-widget ui-widget-header"
            })
            new_tr.append($("<th>").css({
                "padding" : "5px",
                "border"  : "1px solid black"
            }).attr({
                "colspan" : "9"
            }).text("device group " + cur_dg.attr("name")))
            c_table.append(new_tr)
            # at first append metadevice
            cur_dg.find("devices device[selected='selected'][meta_device='1']").each (meta_idx, meta_dev) =>
                c_table.append(@draw_device($(meta_dev)))
            cur_dg.find("devices device[selected='selected'][meta_device='0']").each (dev_idx, cur_dev) =>
                c_table.append(@draw_device($(cur_dev)))
        @top_div.append(c_table)
        @c_table = c_table
    draw_device : (d_el) =>
        dummy_div = $("<div>")
        line_prefix = d_el.attr("key")
        new_tr = $("<tr>").attr({
            "class" : "ui-widget ui-widget-header",
            "id"    : line_prefix
        })
        is_meta = d_el.attr("meta_device") == "1"
        new_tr.append(get_expand_td(line_prefix, "config", "config", @toggle_config_line))
        new_tr.append($("<th>").attr({
            "class"   : "left",
            "colspan" : "8"
        }).text((if is_meta then "Meta device" else "device") + " " + d_el.text()))
        dummy_div.append(new_tr)
        cur_entries = 0
        run_idx = 1
        for cur_conf in @display_list
            console.log cur_conf
            cur_conf = $(cur_conf)
            if !cur_entries
                cur_tr = $("<tr>").attr({
                    "id" : line_prefix + "__config__" + run_idx
                }).hide()
                cur_tr.append($("<td>"))
            cur_cb = $("<input>").attr({
                "type" : "checkbox",
                "id"   : line_prefix + "__config__" + cur_conf.attr("pk")
            }).bind("click", @change_config)

            cur_tr.append(
                $("<td>").attr({
                   "class" : "center"
                }).append(
                    $("<span>").text("")
                ).append(
                    cur_cb
                ).append(
                    $("<span>").text("")
                )
            )
            if @device_configs.find("device_config[device='" + d_el.attr("pk") + "'][config='" + cur_conf.attr("pk") + "'][meta='1']").length
                cur_cb.attr({"checked" : "checked"})
                cur_cb.prev().text("(")
                cur_cb.next().text(")")
            else if @device_configs.find("device_config[device='" + d_el.attr("pk") + "'][config='" + cur_conf.attr("pk") + "']").length
                cur_cb.attr({"checked" : "checked"})
            cur_tr.append($("<td>").append(
                $("<span>").text(cur_conf.attr("name"))
            ))
            cur_entries++
            if cur_entries == 4
                dummy_div.append(cur_tr)
                cur_entries = 0
                run_idx += 1
        if cur_entries
            dummy_div.append(cur_tr)
        return dummy_div.children()
    restore_expansion : (exp_list) =>
        for cur_val in exp_list
            @toggle_config_line(cur_val.split("__")[0] + "__" + cur_val.split("__")[1], true, "config")
    toggle_config_line : (line_prefix, state, line_spec) =>
        conf_line = @c_table.find("tr[id='" + line_prefix + "']")
        exp_line  = @c_table.find("tr[id^='" + line_prefix + "__" + line_spec + "']")
        if state
            exp_line.show()
        else
            exp_line.hide()
    change_config : (event) =>
        cur_cb = $(event.target)
        lock_list = lock_elements(@c_table)
        $.ajax
            url : "{% url config:alter_config_cb %}"
            data : {
                "id"    : cur_cb.attr("id")
                "value" : if cur_cb.is(":checked") then "1" else "0"
            },
            success : (xml) =>
                parse_xml_response(xml)
                res_xml = $(xml)
                # console.log(res_xml);
                conf_pk = res_xml.find("device_configs config").attr("pk")
                res_xml.find("devices device").each (xml_idx, cur_dev) =>
                    # deselect all checkboxes
                    cur_dev = $(cur_dev)
                    cur_cb = @c_table.find("input[id='dev__" + cur_dev.attr("pk") + "__config__" + conf_pk + "']")
                    cur_cb.removeAttr("checked")
                    cur_cb.prev().text("")
                    cur_cb.next().text("")
                res_xml.find("device_configs device_config").each (xml_idx, cur_dc) =>
                    cur_dc = $(cur_dc)
                    cur_cb = @c_table.find("input[id='dev__" + cur_dc.attr("device") + "__config__" + conf_pk + "']")
                    cur_cb.attr("checked", "checked")
                    if cur_dc.attr("meta") == "1"
                        cur_cb.prev().text("(")
                        cur_cb.next().text(")")
                unlock_elements(lock_list)

add_dcon_handlers = ->
    conf_t = new config_table($("div#config"))
    $("input#filter").bind("keyup", => conf_t.apply_filter(false))
    $("input#filter_clear").bind("click", => conf_t.clear_filter())
    install_devsel_link(conf_t.use_devs, true)

$(document).ready(add_dcon_handlers)

{% endinlinecoffeescript %}

</script>

{% endblock %}
