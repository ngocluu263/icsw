{% extends "main.html" %}

{% load i18n compress coffeescript %}

{% block title %}{% trans "Device Configuration" %}{% endblock %}

{% block content %}

<h1 class="center">Device configuration, <span id="config_info">none defined</span>, filter:
<input type="text" id="filter" value=""/>, only selected:
<input type="checkbox" id="filter_assoc"/>,
<input type="button" id="filter_clear" value="clear"/></h1>

<div id="config"></div>

{% include "generate_config.html" %}

<script type="text/javascript">

{% inlinecoffeescript %}

class display_config
    constructor: (cur_conf) ->
        @pk = cur_conf.attr("pk")
        @name = cur_conf.attr("name")
        @num_vars    = cur_conf.find("config_vars *").length
        @num_scripts = cur_conf.find("config_scripts *").length
        @num_checks  = cur_conf.find("mon_check_commands *").length
        @title = "#{@num_vars} variables, #{@num_scripts} scripts, #{@num_checks} check commands"
        
class config_table
    constructor: (@top_div) ->
        @cur_filter = ""
        @show_list = ""
        @only_associated = false
        $("input#filter").bind("keyup", => @apply_filter(false))
        $("input#filter_clear").bind("click", @clear_filter)
        $("input#filter_assoc").bind("click", @change_assoc_filter)
    use_devs: (dt_div) =>
        sel_list = (value.data.key for value in dt_div.dynatree("getSelectedNodes"))
        notify_generate_link(sel_list)
        $.ajax
            url     : "{% url 'device:get_group_tree' %}"
            data    : {
                "sel_list"  : sel_list
                "full_name" : 1
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @devices = $(xml).find("value[name='response']")
                    @load_device_configs(sel_list)
    load_device_configs : (sel_list) =>
        $.ajax
            url     : "{% url 'config:get_device_configs' %}"
            data    : {
                "sel_list" : sel_list
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @device_configs = $(xml).find("value[name='response']")
                    @load_configs()
    load_configs : () =>
        $.ajax
            url     : "{% url 'config:show_configs' %}"
            data    : {
                #"mode" : "simple"
                "mode" : "full"
            }
            success : (xml) =>
                if parse_xml_response(xml)
                    @configs = $(xml).find("value[name='response']")
                    @apply_filter(true)
    change_assoc_filter: (event) =>
        cur_el = $(event.target)
        @only_associated = cur_el.is(":checked")
        @apply_filter(true)
    apply_filter : (force_reload) =>
        cur_text = $("input#filter").attr("value")
        if (cur_text != @cur_filter) or force_reload
            @cur_filter = cur_text
            cur_re = new RegExp("^.*#{@cur_filter}.*$")
            disp_list = new Array()
            # get keys/pks for current filter
            @configs.find("config").each (idx, c_config) =>
                c_config = $(c_config)
                if c_config.attr("name").match(cur_re)
                    if @only_associated
                        conf_pk = c_config.attr("pk")
                        if @device_configs.find("device_config[config='#{conf_pk}']").length
                            disp_list.push(c_config.attr("key"))
                    else
                        disp_list.push(c_config.attr("key"))
            # not working, FIXME
            if (@show_list != disp_list) or force_reload
                # build fast display list
                @display_list = (new display_config(@configs.find("config[key='#{name}']")) for name in disp_list)
                @update_config_info(disp_list.length)
                cur_exp_list = @get_expand_list()
                @draw_tables()
                @restore_expansion(cur_exp_list)
            @show_list = disp_list
    get_expand_list : =>
        if @c_table
            ret_list = ($(cur_el).attr("id") for cur_el in @c_table.find("tr div[id*='__expand__'][class*='-1-s']"))
        else
            ret_list = []
        return ret_list
    update_config_info : (num_shown) =>
        info_str = "configs defined: " + @configs.find("config").length
        if num_shown == @configs.find("config").length
            info_str += ", all shown"
        else
            info_str += ", #{num_shown} shown"
        $("span#config_info").text(info_str)
    clear_filter : =>
        $("input#filter").val("")
        $("input#filter_assoc").removeAttr("checked")
        @only_associated = false
        @apply_filter(false)
    draw_tables : =>
        @selected = {}
        @meta_selected = {}
        # fill selected / meta selected
        @devices.find("device[selected='selected']").each (dev_idx, cur_dev) =>
            dev_pk = $(cur_dev).attr("pk")
            @selected[dev_pk] = []
            @meta_selected[dev_pk] = []
        @device_configs.find("device_config").each (idx, cur_dc) =>
            cur_dc = $(cur_dc)
            if cur_dc.attr("meta") == "1"
                @meta_selected[cur_dc.attr("device")].push(cur_dc.attr("config"))
            else
                @selected[cur_dc.attr("device")].push(cur_dc.attr("config"))
        @top_div.children().remove()
        c_table = $("<table>").attr({"id" : "config"}).addClass("devicelist")
        @devices.find("device_group").each (idx, cur_dg) =>
            cur_dg = $(cur_dg)
            new_tr = $("<tr>").attr({
                "class"   : "ui-widget ui-widget-header devicegroup"
            })
            new_tr.append($("<th>").css({
                "padding" : "5px",
                "border"  : "1px solid black"
            }).attr({
                "colspan" : "5"
            }).text("device group " + cur_dg.attr("name")))
            c_table.append(new_tr)
            # at first append metadevice
            cur_dg.find("devices device[selected='selected'][meta_device='1']").each (meta_idx, meta_dev) =>
                c_table.append(@draw_device($(meta_dev)))
            cur_dg.find("devices device[selected='selected'][meta_device='0']").each (dev_idx, cur_dev) =>
                c_table.append(@draw_device($(cur_dev)))
        @top_div.append(c_table)
        @c_table = c_table
    draw_device : (d_el) =>
        dev_pk = d_el.attr("pk")
        dummy_div = $("<div>")
        line_prefix = d_el.attr("key")
        new_tr = $("<tr>").attr({
            "class" : "ui-widget ui-widget-header",
            "id"    : line_prefix
        })
        new_tr.append(get_expand_td(line_prefix, "config", "config", @toggle_config_line))
        new_tr.append($("<th>").attr({
            "class"   : "left",
            "colspan" : "4",
            "id"      : dev_pk,
        }))
        dummy_div.append(new_tr)
        cur_entries = 0
        run_idx = 1
        for cur_conf in @display_list
            conf_pk = cur_conf.pk
            if !cur_entries
                cur_tr = $("<tr>").attr({
                    "id" : "#{line_prefix}__config__#{run_idx}"
                })
                cur_tr.append(
                    $("<td>")
                )
            num_vars    = cur_conf.num_vars
            num_scripts = cur_conf.num_scripts
            num_checks  = cur_conf.num_checks
            text_td = $("<td>").attr(
                "id" : "#{line_prefix}__config__#{conf_pk}"
            ).on(
                "hover", @hover
            ).on(
                "click", @change_config
            ).attr(
                "title", cur_conf.title
            ).text(
                cur_conf.name + " (#{num_vars}, #{num_scripts}, #{num_checks})"
            )
            if conf_pk in @meta_selected[dev_pk]
                text_td.addClass("meta_selected")
            else if conf_pk in @selected[dev_pk]
                text_td.addClass("selected")
            cur_tr.append(text_td)
            cur_entries++
            if cur_entries == 4
                dummy_div.append(cur_tr)
                cur_entries = 0
                run_idx += 1
        @update_device_info(dev_pk, new_tr.find("th"))
        if cur_entries
            # add dummy entries for colorization
            cur_tr.append($("<td>").attr("colspan", (4 - cur_entries)))
            dummy_div.append(cur_tr)
        # beautify it
        dummy_div.find("tr[id*='__config__']").hide()
        dummy_div.find("tr:even").addClass("even")
        dummy_div.find("tr:odd").addClass("odd")
        return dummy_div.children()
    hover: (event) ->
        target = $(event.target)
        if event.type == "mouseenter"
            target.addClass("highlight")
        else
            target.removeClass("highlight")
    restore_expansion : (exp_list) =>
        for cur_val in exp_list
            @toggle_config_line(cur_val.split("__")[0] + "__" + cur_val.split("__")[1], true, "config")
    toggle_config_line : (line_prefix, state, line_spec) =>
        conf_line = @c_table.find("tr[id='#{line_prefix}']")
        exp_line  = @c_table.find("tr[id^='#{line_prefix}__#{line_spec}']")
        if state
            exp_line.show()
            force_expansion_state(conf_line, true)
        else
            exp_line.hide()
            force_expansion_state(conf_line, false)
    update_device_info: (dev_pk, dev_th) =>
        selected = @selected[dev_pk].length
        meta_selected = @meta_selected[dev_pk].length
        cur_dev = @devices.find("device[pk='#{dev_pk}']")
        is_meta = cur_dev.attr("meta_device") == "1"
        dev_str = (if is_meta then "Meta device" else "device") + " " + cur_dev.text()
        if selected
            dev_str = "#{dev_str}, #{selected} selected"
        if meta_selected
            dev_str = "#{dev_str}, #{meta_selected} via meta"
        if dev_th
            dev_th.text(dev_str)
        else
            @c_table.find("tr th[id='#{dev_pk}']").text(dev_str)
    change_config : (event) =>
        cur_td = $(event.target)
        lock_list = lock_elements(@c_table)
        $.ajax
            url  : "{% url 'config:alter_config_cb' %}"
            data : {
                "id"    : cur_td.attr("id")
                "value" : if (cur_td.hasClass("meta_selected") or cur_td.hasClass("selected")) then "0" else "1"
            },
            success : (xml) =>
                parse_xml_response(xml)
                res_xml = $(xml)
                conf_pk = res_xml.find("device_configs config").attr("pk")
                # remove selection
                for dev_pk of @selected
                    @selected[dev_pk]      = @selected[dev_pk].filter (val) -> val != conf_pk
                    @meta_selected[dev_pk] = @meta_selected[dev_pk].filter (val) -> val != conf_pk
                res_xml.find("devices device").each (xml_idx, cur_dev) =>
                    # deselect all checkboxes
                    cur_dev = $(cur_dev)
                    dev_pk = cur_dev.attr("pk")
                    cur_td = @c_table.find("td[id='dev__#{dev_pk}__config__#{conf_pk}']")
                    cur_td.removeClass("meta_selected").removeClass("selected")
                res_xml.find("device_configs device_config").each (xml_idx, cur_dc) =>
                    cur_dc = $(cur_dc)
                    dev_pk = cur_dc.attr("device")
                    if dev_pk of @selected
                        cur_td = @c_table.find("td[id='dev__#{dev_pk}__config__#{conf_pk}']")
                        if cur_dc.attr("meta") == "1"
                            cur_td.addClass("meta_selected")
                            @meta_selected[dev_pk].push(conf_pk)
                        else
                            cur_td.addClass("selected")
                            @selected[dev_pk].push(conf_pk)
                for dev_pk, sel_list of @selected
                    @update_device_info(dev_pk)
                unlock_elements(lock_list)

add_dcon_handlers = ->
    conf_t = new config_table($("div#config"))
    install_devsel_link(conf_t.use_devs, true)

$(document).ready(add_dcon_handlers)

{% endinlinecoffeescript %}

</script>

{% endblock %}
